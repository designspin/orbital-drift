(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();class V{gameTime=0;maxStep=.05;lastTime=0;fps=0;isPaused=!1;tick(){if(this.isPaused)return 0;const t=performance.now();let e=(t-this.lastTime)/1e3;return this.fps=1e3/(t-this.lastTime),this.lastTime=t,e>this.maxStep&&(e=this.maxStep),this.gameTime+=e,e}pause(){this.isPaused=!0}resume(){this.isPaused=!1,this.lastTime=performance.now()}getGameTime(){return this.gameTime}getFPS(){return Math.round(this.fps)}}class O{keys=new Set;justPressed=new Set;justReleased=new Set;onKeyDown=t=>{t.repeat||(this.keys.add(t.key),this.justPressed.add(t.key))};onKeyUp=t=>{this.keys.delete(t.key),this.justReleased.add(t.key)};constructor(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp)}dispose(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}update(){this.justPressed.clear(),this.justReleased.clear()}isDown(t){return this.keys.has(t)}wasPressed(t){return this.justPressed.has(t)}wasReleased(t){return this.justReleased.has(t)}}class U{entities=[];add(t){this.entities.push(t)}remove(t){this.entities=this.entities.filter(e=>e!==t)}update(t,e){for(const i of this.entities)i.update(t,e);this.handleCollisions(),this.entities=this.entities.filter(i=>i.alive)}render(t){for(const e of this.entities)e.render(t)}clear(){this.entities=[]}handleCollisions(){const t=this.entities.filter(i=>"colliderType"in i),e=i=>typeof i.layer=="number"&&typeof i.mask=="number";for(let i=0;i<t.length;i++)for(let s=i+1;s<t.length;s++){const o=t[i],n=t[s];if(e(o)&&e(n)&&((o.mask&n.layer)===0||(n.mask&o.layer)===0))continue;let a=!1;if(o.colliderType==="circle"&&n.colliderType==="circle"){const r=o.position.x-n.position.x,d=o.position.y-n.position.y;Math.sqrt(r*r+d*d)<o.radius+n.radius&&(a=!0)}else if(o.colliderType==="box"&&n.colliderType==="box")o.position.x<n.position.x+n.width&&o.position.x+o.width>n.position.x&&o.position.y<n.position.y+n.height&&o.position.y+o.height>n.position.y&&(a=!0);else{let r,d;o.colliderType==="circle"?(r=o,d=n):(r=n,d=o);const c=Math.max(d.position.x,Math.min(r.position.x,d.position.x+d.width)),l=Math.max(d.position.y,Math.min(r.position.y,d.position.y+d.height)),u=r.position.x-c,p=r.position.y-l;u*u+p*p<r.radius*r.radius&&(a=!0)}a&&(o.onCollision(n),n.onCollision(o))}}}class ${timer=new V;input=new O;entityManager=new U;isRunning=!1;hasLoopStarted=!1;ctx;uiLayers=[];uiCanvas;uiCtx;uiUpdateIntervalMs=0;uiTimeSinceUpdateMs=0;get screenSize(){return{x:this.ctx.canvas.width,y:this.ctx.canvas.height}}get running(){return this.isRunning}init(t){const e=document.querySelector(t.selector);if(!e)throw new Error(`Element with selector "${t.selector}" not found.`);const i=document.createElement("canvas");i.width=t.width||800,i.height=t.height||600,i.style.backgroundColor=t.backgroundColor||"black",i.id="game",e.appendChild(i),i.focus();const s=i.getContext("2d");if(!s)throw new Error("Failed to get 2D context from canvas.");this.ctx=s,this.onInit()}onInit(){}start(){this.isRunning||(this.isRunning=!0,this.timer.resume(),this.onResume(),this.hasLoopStarted||(this.hasLoopStarted=!0,requestAnimationFrame(this.gameLoop.bind(this))))}stop(){this.isRunning=!1,this.timer.pause(),this.onPause()}onPause(){}onResume(){}canTogglePause(){return!0}gameLoop(){this.input.wasPressed("Escape")&&this.canTogglePause()&&(this.isRunning?this.stop():(this.isRunning=!0,this.timer.resume(),this.onResume()));let t=0;this.isRunning&&(t=this.timer.tick(),this.update(t),this.render());const e=this.isRunning?t:1/60;this.updateAndRenderUI(e),this.input.update(),requestAnimationFrame(this.gameLoop.bind(this))}update(t){this.entityManager.update(t,this.screenSize)}render(t){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.save(),this.entityManager.render(this.ctx),t&&t(),this.ctx.restore()}updateAndRenderUI(t){if(!this.uiCtx||this.uiLayers.length===0||(this.uiTimeSinceUpdateMs+=t*1e3,this.uiUpdateIntervalMs>0&&this.uiTimeSinceUpdateMs<this.uiUpdateIntervalMs))return;this.uiTimeSinceUpdateMs=0;const e=this.uiCanvas.width,i=this.uiCanvas.height;for(const s of this.uiLayers)s.update(t);this.uiCtx.clearRect(0,0,e,i);for(const s of this.uiLayers)s.render(this.uiCtx,e,i)}addUILayer(t){this.uiCtx||this.createUiCanvas(),this.uiLayers.push(t)}removeUILayer(t){this.uiLayers=this.uiLayers.filter(e=>e!==t)}setUiUpdateInterval(t){this.uiUpdateIntervalMs=Math.max(0,t)}createUiCanvas(){const t=this.ctx.canvas.parentElement;if(!t)return;window.getComputedStyle(t).position==="static"&&(t.style.position="relative");const i=document.createElement("canvas");i.width=this.ctx.canvas.width,i.height=this.ctx.canvas.height,i.style.position="absolute",i.style.left="0",i.style.top="0";const s=this.ctx.canvas,o=window.getComputedStyle(s);i.style.width=o.width||s.style.width||"100%",i.style.height=o.height||s.style.height||"100%",i.style.aspectRatio=o.aspectRatio||s.style.aspectRatio||`${s.width} / ${s.height}`,i.style.objectFit=o.objectFit||s.style.objectFit||"contain",i.style.display=o.display||"block",i.style.pointerEvents="none",i.style.zIndex="2",i.id="ui",t.appendChild(i);const n=i.getContext("2d");if(!n)throw new Error("Failed to get 2D context from UI canvas.");this.uiCanvas=i,this.uiCtx=n}addEntity(t){this.entityManager.add(t)}}class v{position;alive;constructor(t={x:0,y:0},e=!0){this.position=t,this.alive=e}}class B{imageQueue=[];images=new Map;taskQueue=[];sounds=new Map;fonts=new Map;queueImage(t,e){this.imageQueue.push({key:t,src:e})}queueSound(t,e,i){this.queueTask("sound",()=>this.loadSound(i,t,e))}queueFont(t,e,i={}){this.queueTask("font",()=>this.loadFont(t,e,i))}queueTask(t,e){this.taskQueue.push({kind:t,run:e})}async loadAll(t){const e=this.imageQueue.length+this.taskQueue.length;let i=0;const s=new Map,o=(l,u)=>{const p=s.get(l)??{loaded:0,total:0};p.total+=u,s.set(l,p)},n=l=>{const u=s.get(l);u&&(u.loaded+=1)};this.imageQueue.length>0&&o("image",this.imageQueue.length);for(const l of this.taskQueue)o(l.kind,1);const a=()=>{const l=e===0?1:i/e,u={};for(const[p,y]of s.entries())u[p]={loaded:y.loaded,total:y.total,percent:y.total===0?1:y.loaded/y.total};t?.({loaded:i,total:e,percent:l,byType:u})};a();const r=this.imageQueue.map(({key:l,src:u})=>this.loadImage(u).then(p=>{this.images.set(l,p),i+=1,n("image"),a()})),d=this.taskQueue.map(({kind:l,run:u})=>u().then(()=>{i+=1,n(l),a()})),c=[...r,...d];await Promise.all(c),this.imageQueue=[],this.taskQueue=[]}getImage(t){const e=this.images.get(t);if(!e)throw new Error(`Image not loaded: ${t}`);return e}getSound(t){const e=this.sounds.get(t);if(!e)throw new Error(`Sound not loaded: ${t}`);return e}getFont(t){const e=this.fonts.get(t);if(!e)throw new Error(`Font not loaded: ${t}`);return e}loadImage(t){return new Promise((e,i)=>{const s=new Image;s.onload=()=>e(s),s.onerror=()=>i(new Error(`Failed to load image: ${t}`)),s.src=t})}async loadSound(t,e,i){const o=await(await fetch(i)).arrayBuffer(),n=await t.decodeAudioData(o);this.sounds.set(e,n)}async loadFont(t,e,i){const o=await new FontFace(t,`url(${e})`,i).load();document.fonts.add(o),this.fonts.set(t,o)}}class q{states=new Map;current;add(t){return this.states.set(t.name,t),this}set(t){const e=this.states.get(t);if(!e)throw new Error(`State not found: ${t}`);const i=this.current;i&&i.name===e.name||(i?.exit?.(e),this.current=e,e.enter?.(i))}update(t){this.current?.update(t)}render(){this.current?.render()}get currentState(){return this.current}}class X{position={x:0,y:0};zoom=1;setPosition(t,e){this.position.x=t,this.position.y=e}move(t,e){this.position.x+=t,this.position.y+=e}follow(t,e,i){const s=e.x/2/this.zoom,o=e.y/2/this.zoom;let n=t.x-s,a=t.y-o;n=Math.max(0,Math.min(n,i.x-e.x/this.zoom)),a=Math.max(0,Math.min(a,i.y-e.y/this.zoom)),this.position.x=n,this.position.y=a}apply(t){t.save(),t.scale(this.zoom,this.zoom),t.translate(-this.position.x,-this.position.y)}unapply(t){t.restore()}}class G{ctx;buffers=new Map;musicSource;musicGain;constructor(){this.ctx=new AudioContext}getContext(){return this.ctx}registerSound(t,e){this.buffers.set(t,e)}async loadSound(t,e){const s=await(await fetch(e)).arrayBuffer(),o=await this.ctx.decodeAudioData(s);this.buffers.set(t,o)}async loadAll(t){await Promise.all(t.map(e=>this.loadSound(e.key,e.src)))}async resume(){this.ctx.state==="suspended"&&await this.ctx.resume()}playSound(t,e=1){const i=this.buffers.get(t);if(!i)return;const s=this.ctx.createBufferSource(),o=this.ctx.createGain();s.buffer=i,o.gain.value=e,s.connect(o).connect(this.ctx.destination),s.start(0)}playMusic(t,e=.6){const i=this.buffers.get(t);if(!i)return;this.stopMusic();const s=this.ctx.createBufferSource(),o=this.ctx.createGain();s.buffer=i,s.loop=!0,o.gain.value=e,s.connect(o).connect(this.ctx.destination),s.start(0),this.musicSource=s,this.musicGain=o}stopMusic(){this.musicSource&&(this.musicSource.stop(),this.musicSource.disconnect(),this.musicSource=void 0,this.musicGain=void 0)}setMusicVolume(t){this.musicGain&&(this.musicGain.gain.value=t)}}class Y{listeners={};on(t,e){const i=this.listeners[t]??new Set;return i.add(e),this.listeners[t]=i,()=>this.off(t,e)}off(t,e){const i=this.listeners[t];i&&(i.delete(e),i.size===0&&delete this.listeners[t])}emit(t,e){const i=this.listeners[t];if(i)for(const s of i)s(e)}clear(){this.listeners={}}}const j=h=>Math.max(0,Math.min(1,h)),Q=h=>(h=j(h),-(Math.cos(Math.PI*h)-1)/2),m=(h,t)=>h===void 0?t:typeof h=="number"?h:h.min+Math.random()*(h.max-h.min),M=(h,t,e)=>Math.max(t,Math.min(e,h)),w=(h,t,e)=>h+(t-h)*e,L=h=>{if(!h.startsWith("#"))return null;const t=h.slice(1);if(t.length===3){const e=parseInt(t[0]+t[0],16),i=parseInt(t[1]+t[1],16),s=parseInt(t[2]+t[2],16);return[e,i,s,1]}if(t.length===6||t.length===8){const e=parseInt(t.slice(0,2),16),i=parseInt(t.slice(2,4),16),s=parseInt(t.slice(4,6),16),o=t.length===8?parseInt(t.slice(6,8),16)/255:1;return[e,i,s,o]}return null},H=(h,t,e)=>{const i=L(h),s=L(t);if(!i||!s)return h;const o=Math.round(w(i[0],s[0],e)),n=Math.round(w(i[1],s[1],e)),a=Math.round(w(i[2],s[2],e)),r=w(i[3],s[3],e);return`rgba(${o}, ${n}, ${a}, ${r})`},K=(h,t)=>typeof h=="function"?h(t):typeof h=="string"?h:H(h.start,h.end,t);class k extends v{particles=[];clear(){this.particles=[]}emit(t){const e=t.count??1,i=t.shape??"circle",s=t.gravity??{x:0,y:0},o=M(t.drag??0,0,1);for(let n=0;n<e;n++){const a=this.getSpawnPosition(t),r=m(t.angle,0)*(Math.PI/180),d=m(t.speed,0),c=Math.max(.01,m(t.life,.6)),l=Math.max(.1,m(t.size,4)),u=Math.max(0,m(t.sizeEnd,l)),p=M(m(t.opacity,1),0,1),y=M(m(t.opacityEnd,0),0,1),g=m(t.rotation,0),T=m(t.angularVelocity,0),E={x:Math.cos(r)*d,y:Math.sin(r)*d};this.particles.push({position:a,velocity:E,age:0,life:c,size:l,sizeEnd:u,opacity:p,opacityEnd:y,rotation:g,angularVelocity:T,color:t.color??"#ffffff",shape:i,sprite:t.sprite,blendMode:t.blendMode,gravity:s,drag:o})}}update(t){for(const e of this.particles){if(e.age+=t,e.age>=e.life){e.opacity=0;continue}e.velocity.x+=e.gravity.x*t,e.velocity.y+=e.gravity.y*t,e.velocity.x*=1-e.drag,e.velocity.y*=1-e.drag,e.position.x+=e.velocity.x*t,e.position.y+=e.velocity.y*t,e.rotation+=e.angularVelocity*t}this.particles=this.particles.filter(e=>e.age<e.life)}render(t){for(const e of this.particles){const i=M(e.age/e.life,0,1),s=w(e.size,e.sizeEnd,i),o=w(e.opacity,e.opacityEnd,i);if(o<=0||s<=0)continue;t.save(),e.blendMode&&(t.globalCompositeOperation=e.blendMode),t.globalAlpha=o,t.translate(e.position.x,e.position.y),t.rotate(e.rotation);const n=K(e.color,i);if(e.shape==="sprite"&&e.sprite){const a=s*2,r=s*2;t.drawImage(e.sprite,-a/2,-r/2,a,r)}else e.shape==="square"?(t.fillStyle=n,t.fillRect(-s/2,-s/2,s,s)):e.shape==="triangle"?(t.fillStyle=n,t.beginPath(),t.moveTo(0,-s),t.lineTo(s,s),t.lineTo(-s,s),t.closePath(),t.fill()):e.shape==="line"?(t.strokeStyle=n,t.lineWidth=Math.max(1,s*.35),t.beginPath(),t.moveTo(-s,0),t.lineTo(s,0),t.stroke()):(t.fillStyle=n,t.beginPath(),t.arc(0,0,s,0,Math.PI*2),t.fill());t.restore()}}getSpawnPosition(t){const e=t.spawnShape??"point",i=t.position;if(e==="circle"){const s=t.spawnRadius??4,o=Math.random()*Math.PI*2,n=Math.random()*s;return{x:i.x+Math.cos(o)*n,y:i.y+Math.sin(o)*n}}if(e==="rect"){const s=t.spawnWidth??8,o=t.spawnHeight??8;return{x:i.x+(Math.random()-.5)*s,y:i.y+(Math.random()-.5)*o}}return{x:i.x,y:i.y}}}class S{anchor;offsetX;offsetY;parent;constructor(t={}){this.anchor=t.anchor??"top-left",this.offsetX=t.offsetX??0,this.offsetY=t.offsetY??0,this.parent=t.parent??null}update(t){}getAnchorPoint(t,e){switch(this.anchor){case"top-left":return{x:0,y:0};case"top-right":return{x:t,y:0};case"bottom-left":return{x:0,y:e};case"bottom-right":return{x:t,y:e};case"center":return{x:t/2,y:e/2}}}getLocalPosition(t,e){const i=this.getAnchorPoint(t,e);return{x:i.x+this.offsetX,y:i.y+this.offsetY}}}class A{name;visible=!0;elements=[];constructor(t){this.name=t}add(t){this.elements.push(t)}remove(t){this.elements=this.elements.filter(e=>e!==t)}setVisible(t){this.visible=t}update(t){if(this.visible)for(const e of this.elements)e.update(t)}render(t,e,i){if(this.visible)for(const s of this.elements)s.render(t,e,i)}}class b extends S{width;height;backgroundColor;borderColor;borderWidth;borderRadius;children=[];constructor(t){super(t),this.width=t.width,this.height=t.height,this.backgroundColor=t.backgroundColor??"rgba(0,0,0,0.5)",this.borderColor=t.borderColor??"rgba(255,255,255,0.2)",this.borderWidth=t.borderWidth??0,this.borderRadius=t.borderRadius??0}add(t){t.parent=this,this.children.push(t)}update(t){for(const e of this.children)e.update(t)}render(t,e,i){const s=this.getLocalPosition(e,i);t.save(),t.translate(s.x,s.y);const o=Math.max(0,Math.min(this.borderRadius,Math.min(this.width,this.height)/2));o>0?(t.beginPath(),t.moveTo(o,0),t.lineTo(this.width-o,0),t.quadraticCurveTo(this.width,0,this.width,o),t.lineTo(this.width,this.height-o),t.quadraticCurveTo(this.width,this.height,this.width-o,this.height),t.lineTo(o,this.height),t.quadraticCurveTo(0,this.height,0,this.height-o),t.lineTo(0,o),t.quadraticCurveTo(0,0,o,0),t.closePath(),t.fillStyle=this.backgroundColor,t.fill(),this.borderWidth>0&&(t.strokeStyle=this.borderColor,t.lineWidth=this.borderWidth,t.stroke())):(t.fillStyle=this.backgroundColor,t.fillRect(0,0,this.width,this.height),this.borderWidth>0&&(t.strokeStyle=this.borderColor,t.lineWidth=this.borderWidth,t.strokeRect(0,0,this.width,this.height)));for(const n of this.children)n.render(t,this.width,this.height);t.restore()}}class Z extends S{getScore;color;font;constructor(t){super(t),this.getScore=t.getScore,this.color=t.color??"#ffffff",this.font=t.font??"16px sans-serif"}render(t,e,i){const s=this.getLocalPosition(e,i);t.save(),t.font=this.font,t.fillStyle=this.color,t.textAlign=this.anchor==="center"?"center":this.anchor.endsWith("right")?"right":"left",t.textBaseline=this.anchor==="center"?"middle":"top",t.fillText(`SCORE: ${this.getScore()}`,s.x,s.y),t.restore()}}class N extends S{getText;color;font;constructor(t){super(t),this.getText=t.getText,this.color=t.color??"#ffffff",this.font=t.font??"18px sans-serif"}render(t,e,i){const s=this.getLocalPosition(e,i);t.save(),t.font=this.font,t.fillStyle=this.color,t.textAlign=this.anchor==="center"?"center":this.anchor.endsWith("right")?"right":"left",t.textBaseline=this.anchor==="center"?"middle":"top",t.fillText(this.getText(),s.x,s.y),t.restore()}}class J extends S{getValue;width;height;backgroundColor;fillColor;borderColor;borderWidth;constructor(t){super(t),this.getValue=t.getValue,this.width=t.width,this.height=t.height,this.backgroundColor=t.backgroundColor??"rgba(0,0,0,0.5)",this.fillColor=t.fillColor??"#5ac8fa",this.borderColor=t.borderColor??"rgba(255,255,255,0.3)",this.borderWidth=t.borderWidth??1}render(t,e,i){const s=this.getLocalPosition(e,i),o=Math.max(0,Math.min(1,this.getValue()));t.save(),t.translate(s.x,s.y),this.anchor.endsWith("right")?t.translate(-this.width,0):this.anchor==="center"&&t.translate(-this.width/2,0),t.fillStyle=this.backgroundColor,t.fillRect(0,0,this.width,this.height),t.fillStyle=this.fillColor,t.fillRect(0,0,this.width*o,this.height),this.borderWidth>0&&(t.strokeStyle=this.borderColor,t.lineWidth=this.borderWidth,t.strokeRect(0,0,this.width,this.height)),t.restore()}}class z{input;constructor(t){this.input=t}getRotation(){return this.input.isDown("ArrowLeft")?-1:this.input.isDown("ArrowRight")?1:0}isThrusting(){return this.input.isDown("ArrowUp")}}const f={Player:1,PlayerBullet:2,Enemy:4,EnemyBullet:8,Asteroid:16};class R extends v{radius=2;colliderType="circle";layer=f.PlayerBullet;mask=f.Enemy|f.Asteroid;velocity;constructor(t,e,i=400){super(t);const s=e*Math.PI/180;this.velocity={x:Math.cos(s)*i,y:Math.sin(s)*i}}update(t,e){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,(this.position.x<0||this.position.x>e.x||this.position.y<0||this.position.y>e.y)&&(this.alive=!1)}render(t){t.save(),t.translate(this.position.x,this.position.y),t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle="#ffff00",t.fill(),t.restore()}onCollision(t){this.alive=!1}}const _={XL:48,L:32,M:22,S:14},tt={XL:"L",L:"M",M:"S",S:null},et={XL:20,L:50,M:100,S:200};class x extends v{radius;colliderType="circle";layer=f.Asteroid;mask=f.Player|f.PlayerBullet;size;angle;rotationSpeed;velocity;shapePoints;shouldSplit=!1;hasSplit=!1;onDestroyed;hasScored=!1;constructor(t,e="L",i){super(t),this.size=e,this.radius=_[e],this.onDestroyed=i,this.angle=Math.random()*360,this.rotationSpeed=(Math.random()-.5)*90;const s=50+Math.random()*100,o=Math.random()*Math.PI*2;this.velocity={x:Math.cos(o)*s,y:Math.sin(o)*s};const n=8;this.shapePoints=Array.from({length:n},(a,r)=>({angle:r*Math.PI*2/n,scale:.75+Math.random()*.5}))}update(t,e){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t;const i=e.x,s=e.y;(this.position.x<0||this.position.x>i)&&(this.velocity.x*=-1,this.position.x=Math.max(0,Math.min(this.position.x,i))),(this.position.y<0||this.position.y>s)&&(this.velocity.y*=-1,this.position.y=Math.max(0,Math.min(this.position.y,s))),this.angle+=this.rotationSpeed*t}render(t){const e=this.radius;t.save(),t.translate(this.position.x,this.position.y),t.rotate(this.angle*Math.PI/180),t.beginPath();const i=this.shapePoints[0];t.moveTo(Math.cos(i.angle)*e*i.scale,Math.sin(i.angle)*e*i.scale);for(let s=1;s<this.shapePoints.length;s++){const o=this.shapePoints[s];t.lineTo(Math.cos(o.angle)*e*o.scale,Math.sin(o.angle)*e*o.scale)}t.closePath(),t.strokeStyle="#ffffff",t.lineWidth=2,t.stroke(),t.restore()}setVelocity(t){this.velocity=t}getVelocity(){return{x:this.velocity.x,y:this.velocity.y}}setPosition(t){this.position=t}split(){if(!this.shouldSplit||this.hasSplit)return[];this.hasSplit=!0;const t=tt[this.size];if(!t)return[];const e=this.radius*.8,i=Math.random()*Math.PI*2,s=Math.cos(i)*e,o=Math.sin(i)*e,n=new x({x:this.position.x+s,y:this.position.y+o},t,this.onDestroyed),a=new x({x:this.position.x-s,y:this.position.y-o},t,this.onDestroyed);return n.setVelocity({x:this.velocity.x+s*2,y:this.velocity.y+o*2}),a.setVelocity({x:this.velocity.x-s*2,y:this.velocity.y-o*2}),[n,a]}getScoreValue(){return et[this.size]}onCollision(t){if(t instanceof R){this.hasScored||(this.hasScored=!0,this.onDestroyed?.(this)),this.shouldSplit=!0,this.alive=!1;return}t instanceof x&&x.resolveCollision(this,t)}static resolveCollision(t,e){const i=e.position.x-t.position.x,s=e.position.y-t.position.y,o=Math.hypot(i,s)||1,n=i/o,a=s/o,r=t.radius+e.radius-o;if(r>0){const g=r/2;t.position.x-=n*g,t.position.y-=a*g,e.position.x+=n*g,e.position.y+=a*g}const d=e.velocity.x-t.velocity.x,c=e.velocity.y-t.velocity.y,l=d*n+c*a;if(l>0)return;const u=-1.9*l/2,p=u*n,y=u*a;t.velocity.x-=p,t.velocity.y-=y,e.velocity.x+=p,e.velocity.y+=y}}class P extends v{radius=18;colliderType="circle";layer=f.Enemy;mask=f.Player|f.PlayerBullet;sprite;speed=80;angle=0;shootCooldown=0;fireInterval=3.2;getTarget;onShoot;onDestroyed;hasScored=!1;constructor(t,e,i,s,o){super(t),this.getTarget=e,this.onShoot=i,this.sprite=s,this.onDestroyed=o}update(t,e){const i=this.getTarget(),s=i.x-this.position.x,o=i.y-this.position.y,n=Math.hypot(s,o)||1,a=s/n,r=o/n;this.position.x+=a*this.speed*t,this.position.y+=r*this.speed*t,this.position.x=Math.max(0,Math.min(this.position.x,e.x)),this.position.y=Math.max(0,Math.min(this.position.y,e.y)),this.angle=Math.atan2(o,s)*180/Math.PI,this.shootCooldown-=t,this.shootCooldown<=0&&(this.shootCooldown=this.fireInterval,this.onShoot({x:this.position.x,y:this.position.y},this.angle))}render(t){if(t.save(),t.translate(this.position.x,this.position.y),t.rotate(this.angle*Math.PI/180),this.sprite){t.rotate(Math.PI/2);const e=this.radius*2.4/this.sprite.width,i=this.sprite.width*e,s=this.sprite.height*e;t.drawImage(this.sprite,-i/2,-s/2,i,s)}else t.fillStyle="#ff6b6b",t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fill();t.restore()}onCollision(t){t instanceof P||t instanceof R&&(this.hasScored||(this.hasScored=!0,this.onDestroyed?.({x:this.position.x,y:this.position.y})),this.alive=!1)}}class C extends v{radius=15;colliderType="circle";layer=f.Player;mask=f.Enemy|f.EnemyBullet|f.Asteroid;angle=0;velocity={x:0,y:0};thrust=0;friction=.98;sprite;shieldActive=!1;get controller(){return this._controller}_controller;constructor(t,e,i){super(t),this._controller=e,this.sprite=i}setShieldActive(t){this.shieldActive=t}isShieldActive(){return this.shieldActive}isThrusting(){return this.controller.isThrusting()}update(t,e){this.angle+=this.controller.getRotation()*180*t,this.controller.isThrusting()?this.thrust=200:this.thrust=0,this.velocity.x+=Math.cos(this.angle*Math.PI/180)*this.thrust*t,this.velocity.y+=Math.sin(this.angle*Math.PI/180)*this.thrust*t,this.velocity.x*=this.friction,this.velocity.y*=this.friction,this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t;const i=e.x,s=e.y;this.position.x<0&&(this.position.x+=i),this.position.x>i&&(this.position.x-=i),this.position.y<0&&(this.position.y+=s),this.position.y>s&&(this.position.y-=s)}render(t){if(t.save(),t.translate(this.position.x,this.position.y),this.shieldActive&&(t.save(),t.beginPath(),t.arc(0,0,this.radius*1.7,0,Math.PI*2),t.strokeStyle="rgba(90, 200, 250, 0.9)",t.lineWidth=2,t.stroke(),t.restore()),t.rotate(this.angle*Math.PI/180),this.sprite){t.rotate(Math.PI/2);const e=this.radius*2.4/this.sprite.width,i=this.sprite.width*e,s=this.sprite.height*e;t.drawImage(this.sprite,-i/2,-s/2,i,s)}else{const i=this.radius*1.3;t.beginPath(),t.moveTo(i,0),t.lineTo(-i*.6,-i*.6),t.lineTo(-i*.3,0),t.lineTo(-i*.6,i*.6),t.closePath(),t.strokeStyle="#ffffff",t.lineWidth=2,t.lineJoin="round",t.stroke()}t.restore()}getAngle(){return this.angle}getSpeed(){return Math.hypot(this.velocity.x,this.velocity.y)}onCollision(t){if(this.shieldActive&&t instanceof P){t.alive=!1;return}if(this.shieldActive&&t instanceof x){const e=t.position.x-this.position.x,i=t.position.y-this.position.y,s=Math.hypot(e,i)||1,o=e/s,n=i/s,a=Math.hypot(t.getVelocity().x,t.getVelocity().y)||120;t.setVelocity({x:o*a,y:n*a}),t.position.x+=o*(t.radius+this.radius),t.position.y+=n*(t.radius+this.radius);return}this.shieldActive||(this.alive=!1)}}class it extends S{getLives;maxLives;color;size;spacing;constructor(t){super(t),this.getLives=t.getLives,this.maxLives=t.maxLives??3,this.color=t.color??"#00ff6a",this.size=t.size??12,this.spacing=t.spacing??8}render(t,e,i){const s=this.getLocalPosition(e,i),o=Math.max(0,Math.min(this.getLives(),this.maxLives));t.save(),t.translate(s.x,s.y);const n=o>0?o*this.size+(o-1)*this.spacing:0,a=this.anchor==="center"?-n/2:this.anchor.endsWith("right")?-n:0,r=this.anchor==="center"?this.size*.15:0;for(let d=0;d<o;d++){const c=a+d*(this.size+this.spacing)+this.size/2;this.drawShip(t,c,r)}t.restore()}drawShip(t,e,i){const s=this.size;t.save(),t.translate(e,i),t.beginPath(),t.moveTo(0,-s),t.lineTo(-s*.6,s*.7),t.lineTo(0,s*.3),t.lineTo(s*.6,s*.7),t.closePath(),t.strokeStyle=this.color,t.lineWidth=2,t.lineJoin="round",t.stroke(),t.restore()}}class st extends S{getAsteroids;getEnemies;getPlayer;getWorldSize;width;height;asteroidColor;enemyColor;playerColor;dotRadius;constructor(t){super(t),this.getAsteroids=t.getAsteroids,this.getEnemies=t.getEnemies,this.getPlayer=t.getPlayer,this.getWorldSize=t.getWorldSize,this.width=t.width,this.height=t.height,this.asteroidColor=t.asteroidColor??"#ffffff",this.enemyColor=t.enemyColor??"#ff3b30",this.playerColor=t.playerColor??"#3da5ff",this.dotRadius=t.dotRadius??2}render(t,e,i){const s=this.getLocalPosition(e,i),o=8,n=this.width-o*2,a=this.height-o*2,r=this.getWorldSize(),d=this.getPlayer();if(!d)return;t.save(),t.translate(s.x,s.y),t.beginPath(),t.rect(0,0,this.width,this.height),t.clip();const c=(l,u)=>{const p=l.position.x-d.x,y=l.position.y-d.y,g=r.x>0?p/r.x:0,T=r.y>0?y/r.y:0,E=o+n/2+g*n,W=o+a/2+T*a,D=Math.max(o,Math.min(E,o+n)),F=Math.max(o,Math.min(W,o+a));t.fillStyle=u,t.beginPath(),t.arc(D,F,this.dotRadius,0,Math.PI*2),t.fill()};for(const l of this.getAsteroids())c(l,this.asteroidColor);for(const l of this.getEnemies())c(l,this.enemyColor);t.fillStyle=this.playerColor,t.beginPath(),t.arc(o+n/2,o+a/2,this.dotRadius+.5,0,Math.PI*2),t.fill(),t.restore()}}class ot extends v{radius=3;colliderType="circle";layer=f.EnemyBullet;mask=f.Player;velocity;constructor(t,e,i=260){super(t);const s=e*Math.PI/180;this.velocity={x:Math.cos(s)*i,y:Math.sin(s)*i}}update(t,e){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,(this.position.x<0||this.position.x>e.x||this.position.y<0||this.position.y>e.y)&&(this.alive=!1)}render(t){t.save(),t.translate(this.position.x,this.position.y),t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle="#ff3b30",t.fill(),t.restore()}onCollision(t){if(t instanceof C){if(t.isShieldActive()){this.alive=!1;return}t.alive=!1,this.alive=!1}}}class nt extends ${assets=new B;audio=new G;camera=new X;particles=new k;events=new Y;worldSize={x:2400,y:1800};progress=0;shipSprite;enemySprite;score=0;lives=3;shieldEnergy=1;shieldActive=!1;shieldDrainRate=.35;shieldRegenRate=.2;shieldRegenDelay=3;shieldRegenCooldown=0;hudLayer=new A("HUD");pauseLayer=new A("Pause");player;asteroids=[];enemies=[];enemySpawnTimer=0;enemySpawnInterval=2.5;minEnemySpawnDistance=300;maxEnemyCap=20;respawnDelay=2.5;respawnTimer=0;playerDeathExploded=!1;menuPulseTime=0;wave=1;waveEnemiesToSpawn=0;waveEnemiesRemaining=0;waveAsteroidsRemaining=0;waveTransitionTimer=0;waveTransitionDuration=2;stateMachine=new q;menuStars=[];gameOverTime=0;fontFamily='"Space Grotesk", sans-serif';get screenSize(){return this.worldSize}get viewportSize(){return{x:this.ctx.canvas.width,y:this.ctx.canvas.height}}onInit(){this.setUiUpdateInterval(100),this.setupUi(),this.setupEvents(),this.setupMenuStars(),this.setupStates(),this.stateMachine.set("loading")}update(t){this.stateMachine.update(t)}render(){this.stateMachine.render()}updatePlaying(t){this.shieldActive=this.input.isDown("ArrowDown")&&this.shieldEnergy>0;const e=this.player.isThrusting();if(this.input.wasPressed(" ")){const c=this.player.getAngle(),l=c*Math.PI/180,u=this.player.radius*1.2,p={x:this.player.position.x+Math.cos(l)*u,y:this.player.position.y+Math.sin(l)*u};this.addEntity(new R(p,c)),this.events.emit("shot:player",{position:p,angle:c})}if(super.update(t),e&&this.emitThrusterTrail(),this.shieldActive?(this.shieldEnergy=Math.max(0,this.shieldEnergy-this.shieldDrainRate*t),this.shieldEnergy===0&&(this.shieldRegenCooldown=this.shieldRegenDelay)):this.shieldRegenCooldown>0?this.shieldRegenCooldown=Math.max(0,this.shieldRegenCooldown-t):this.shieldEnergy=Math.min(1,this.shieldEnergy+this.shieldRegenRate*t),this.player.setShieldActive(this.shieldActive),!this.player.alive&&(this.playerDeathExploded||(this.playerDeathExploded=!0,this.events.emit("player:destroyed",{position:this.player.position})),this.lives>0&&(this.lives-=1,this.lives>0))){this.respawnTimer=this.respawnDelay,this.stateMachine.set("respawn");return}const i=[];this.asteroids=this.asteroids.filter(c=>c.alive?!0:(i.push(...c.split()),!1));for(const c of i)this.addAsteroid(c);this.enemies=this.enemies.filter(c=>c.alive),this.resolveEnemyOverlaps(),this.updateWaveSpawns(t),this.checkWaveComplete();const s=this.player.getSpeed(),o=.75,n=1.2,r=Math.max(0,Math.min(1,s/180)),d=n-(n-o)*r;this.camera.zoom+=(d-this.camera.zoom)*Math.min(1,t*6),this.camera.follow(this.player.position,this.viewportSize,this.worldSize)}renderPlaying(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.camera.apply(this.ctx),this.ctx.fillStyle="#0b0f1a",this.ctx.fillRect(0,0,this.worldSize.x,this.worldSize.y),this.ctx.strokeStyle="rgba(255,255,255,0.08)",this.ctx.lineWidth=1;const t=200;for(let e=0;e<=this.worldSize.x;e+=t)this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.worldSize.y),this.ctx.stroke();for(let e=0;e<=this.worldSize.y;e+=t)this.ctx.beginPath(),this.ctx.moveTo(0,e),this.ctx.lineTo(this.worldSize.x,e),this.ctx.stroke();this.entityManager.render(this.ctx),this.ctx.strokeStyle="rgba(255,255,255,0.2)",this.ctx.lineWidth=2,this.ctx.strokeRect(0,0,this.worldSize.x,this.worldSize.y),this.camera.unapply(this.ctx),this.waveTransitionTimer>0&&this.renderCenterOverlay(`Wave ${this.wave}`,"Prepare for battle")}renderTextScreen(t,e){const i=this.ctx.canvas.width,s=this.ctx.canvas.height;this.ctx.clearRect(0,0,i,s),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,i,s),this.ctx.fillStyle="#ffffff",this.ctx.font='36px "Space Grotesk", sans-serif',this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t,i/2,s/2-20),e&&(this.ctx.fillStyle="rgba(255,255,255,0.8)",this.ctx.font='18px "Space Grotesk", sans-serif',this.ctx.fillText(e,i/2,s/2+20))}renderTitleScreen(){const t=this.ctx.canvas.width,e=this.ctx.canvas.height;this.ctx.clearRect(0,0,t,e),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,t,e),this.renderMenuStars(t,e,this.menuPulseTime),this.ctx.font=`56px ${this.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.lineWidth=3,this.ctx.strokeStyle="rgba(180,180,180,0.9)",this.ctx.strokeText("Orbital Drift",t/2,e/2-28),this.ctx.fillStyle="#ffffff",this.ctx.fillText("Orbital Drift",t/2,e/2-28);const i=(Math.sin(this.menuPulseTime*Math.PI*1.2)+1)/2,s=.25+.75*Q(i);this.ctx.fillStyle=`rgba(255,255,255,${s.toFixed(3)})`,this.ctx.font=`18px ${this.fontFamily}`,this.ctx.fillText("Press Enter to Start",t/2,e/2+28)}renderGameOver(){const t=this.ctx.canvas.width,e=this.ctx.canvas.height;this.renderPlaying();const i=Math.max(0,Math.min(1,this.gameOverTime/1.2));this.ctx.save(),this.ctx.fillStyle=`rgba(0,0,0,${(.85*i).toFixed(3)})`,this.ctx.fillRect(0,0,t,e);const s=Math.max(0,Math.min(1,(this.gameOverTime-.2)/1));this.ctx.fillStyle=`rgba(255,255,255,${s.toFixed(3)})`,this.ctx.font=`36px ${this.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Game Over",t/2,e/2-20),this.ctx.font=`18px ${this.fontFamily}`,this.ctx.fillText(`Score: ${this.score}`,t/2,e/2+15),this.ctx.restore()}setupMenuStars(){this.menuStars=Array.from({length:90},()=>({x:Math.random(),y:Math.random(),speed:.02+Math.random()*.08,size:.6+Math.random()*1.4}))}renderMenuStars(t,e,i){this.ctx.save();for(const s of this.menuStars){const o=(s.y+i*s.speed)%1,n=s.x*t,a=o*e,r=.35+.65*(.5+.5*Math.sin(i*2+s.x*12));this.ctx.fillStyle=`rgba(120, 196, 255, ${r.toFixed(3)})`,this.ctx.beginPath(),this.ctx.arc(n,a,s.size,0,Math.PI*2),this.ctx.fill()}this.ctx.restore()}renderCenterOverlay(t,e){const i=this.ctx.canvas.width,s=this.ctx.canvas.height;this.ctx.save(),this.ctx.fillStyle="rgba(0,0,0,0.35)",this.ctx.fillRect(0,0,i,s),this.ctx.fillStyle="#ffffff",this.ctx.font=`32px ${this.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t,i/2,s/2-18),e&&(this.ctx.fillStyle="rgba(255,255,255,0.8)",this.ctx.font=`18px ${this.fontFamily}`,this.ctx.fillText(e,i/2,s/2+18)),this.ctx.restore()}setupUi(){const t=new b({anchor:"top-left",offsetX:(this.ctx.canvas.width-160)/2,offsetY:10,width:160,height:40,backgroundColor:"rgba(0,0,0,0.6)"}),e=new Z({getScore:()=>this.score,anchor:"center",offsetX:0,offsetY:0,parent:t,font:`16px ${this.fontFamily}`});t.add(e),this.hudLayer.add(t);const i=new b({anchor:"top-left",offsetX:(this.ctx.canvas.width-160)/2,offsetY:56,width:160,height:90,backgroundColor:"rgba(0,0,0,0.5)",borderColor:"rgba(255,255,255,0.2)",borderWidth:1,borderRadius:8}),s=new st({getAsteroids:()=>this.asteroids,getEnemies:()=>this.enemies,getPlayer:()=>this.player?.position,getWorldSize:()=>this.worldSize,width:160,height:90,anchor:"top-left",parent:i,offsetX:0,offsetY:0,asteroidColor:"#ffffff",enemyColor:"#ff3b30",playerColor:"#3da5ff",dotRadius:1.5});i.add(s),this.hudLayer.add(i);const o=new b({anchor:"top-right",offsetX:-150,offsetY:10,width:140,height:40,backgroundColor:"rgba(0,0,0,0.4)",borderWidth:0}),n=new it({getLives:()=>this.lives,maxLives:3,anchor:"center",parent:o,color:"#00ff6a",size:10,spacing:10});o.add(n),this.hudLayer.add(o);const a=new J({getValue:()=>this.shieldEnergy,width:120,height:10,anchor:"top-left",offsetX:20,offsetY:20,backgroundColor:"rgba(0,0,0,0.5)",fillColor:(this.shieldActive,"#5ac8fa"),borderColor:"rgba(255,255,255,0.25)",borderWidth:1});this.hudLayer.add(a),this.addUILayer(this.hudLayer);const r=new b({anchor:"center",offsetX:-120,offsetY:-35,width:240,height:70,backgroundColor:"rgba(28, 54, 92, 0.9)",borderColor:"rgba(120, 196, 255, 0.9)",borderWidth:3,borderRadius:16}),d=new N({getText:()=>"PAUSED",anchor:"center",parent:r,offsetY:0,color:"rgba(120, 196, 255, 0.9)",font:`28px ${this.fontFamily}`});r.add(d),this.pauseLayer.add(r),this.pauseLayer.setVisible(!1),this.addUILayer(this.pauseLayer)}setupStates(){const t={name:"loading",enter:()=>{this.hudLayer.setVisible(!1);const a=this.audio.getContext();this.assets.queueSound("doomed","/Alexander Ehlers - Doomed.mp3",a),this.assets.queueSound("flags","/Alexander Ehlers - Flags.mp3",a),this.assets.queueSound("lazerShoot","/laserShoot.wav",a),this.assets.queueSound("laserShootEnemy","/laserShootEnemy.wav",a),this.assets.queueSound("explosion","/explosion.wav",a),this.assets.queueFont("Space Grotesk","/Space_Grotesk/SpaceGrotesk-VariableFont_wght.ttf"),this.assets.queueImage("ship","/spaceship.png"),this.assets.queueImage("enemy","/enemy.png"),this.assets.loadAll(r=>{this.progress=r.percent}).then(()=>{this.shipSprite=this.assets.getImage("ship"),this.enemySprite=this.assets.getImage("enemy"),this.audio.registerSound("doomed",this.assets.getSound("doomed")),this.audio.registerSound("flags",this.assets.getSound("flags")),this.audio.registerSound("lazerShoot",this.assets.getSound("lazerShoot")),this.audio.registerSound("laserShootEnemy",this.assets.getSound("laserShootEnemy")),this.audio.registerSound("explosion",this.assets.getSound("explosion")),this.stateMachine.set("menu")})},update:()=>{},render:()=>{this.renderLoading()}},e={name:"menu",enter:()=>{this.hudLayer.setVisible(!1),this.pauseLayer.setVisible(!1),this.audio.playMusic("doomed",.5),this.menuPulseTime=0},update:a=>{this.menuPulseTime+=a,this.input.wasPressed("Enter")&&(this.audio.resume().then(()=>{this.audio.playMusic("flags",.5)}),this.resetGame(),this.stateMachine.set("playing"))},render:()=>{this.renderTitleScreen()}},i={name:"playing",enter:()=>{this.hudLayer.setVisible(!0),this.pauseLayer.setVisible(!1),this.audio.playMusic("flags",.5)},update:a=>{if(this.input.wasPressed("p")){this.stateMachine.set("paused");return}this.updatePlaying(a),this.lives===0&&!this.player.alive&&this.stateMachine.set("gameover")},render:()=>{this.renderPlaying()}},s={name:"paused",enter:()=>{this.hudLayer.setVisible(!0),this.pauseLayer.setVisible(!0)},update:()=>{this.input.wasPressed("p")&&this.stateMachine.set("playing")},render:()=>{this.renderPlaying()},exit:()=>{this.pauseLayer.setVisible(!1)}},o={name:"respawn",enter:()=>{this.hudLayer.setVisible(!0),this.pauseLayer.setVisible(!1)},update:a=>{if(this.updateWorldDuringRespawn(a),this.respawnTimer=Math.max(0,this.respawnTimer-a),this.particles.update(a),this.respawnTimer===0){const r=this.getSafeSpawnPosition();this.player=new C(r,new z(this.input),this.shipSprite),this.playerDeathExploded=!1,this.addEntity(this.player),this.stateMachine.set("playing")}},render:()=>{this.renderPlaying(),this.renderCenterOverlay("Get Ready",`Respawning in ${Math.ceil(this.respawnTimer)}...`)}},n={name:"gameover",enter:()=>{this.hudLayer.setVisible(!1),this.pauseLayer.setVisible(!1),this.gameOverTime=0},update:a=>{this.gameOverTime+=a,(this.input.wasPressed("Enter")||this.gameOverTime>=3)&&this.stateMachine.set("menu")},render:()=>{this.renderGameOver()}};this.stateMachine.add(t).add(e).add(i).add(s).add(o).add(n)}setupEvents(){this.events.on("shot:player",({position:t,angle:e})=>{this.audio.playSound("lazerShoot",.6),this.emitMuzzleFlash(t,e)}),this.events.on("shot:enemy",({position:t,angle:e})=>{this.audio.playSound("laserShootEnemy",.7),this.emitMuzzleFlash(t,e,"#ff8b8b")}),this.events.on("asteroid:destroyed",({asteroid:t})=>{this.score+=t.getScoreValue(),this.waveAsteroidsRemaining=Math.max(0,this.waveAsteroidsRemaining-1),this.audio.playSound("explosion",.7),this.emitExplosion(t.position,26,"#ffffff","#ff9a7a")}),this.events.on("enemy:destroyed",({position:t})=>{this.waveEnemiesRemaining=Math.max(0,this.waveEnemiesRemaining-1),this.score+=10*this.wave,this.audio.playSound("explosion",.7),this.emitExplosion(t,22,"#ff6b6b","#ffd3a3")}),this.events.on("player:destroyed",({position:t})=>{this.audio.playSound("explosion",.7),this.emitExplosion(t,30,"#7fd1ff","#ffffff")})}updateWorldDuringRespawn(t){super.update(t);const e=[];this.asteroids=this.asteroids.filter(s=>s.alive?!0:(e.push(...s.split()),!1));for(const s of e)this.addAsteroid(s);this.enemies=this.enemies.filter(s=>s.alive),this.resolveEnemyOverlaps(),this.updateWaveSpawns(t),this.checkWaveComplete();const i=this.player?.position??{x:this.worldSize.x/2,y:this.worldSize.y/2};this.camera.follow(i,this.viewportSize,this.worldSize)}resetGame(){this.score=0,this.lives=3,this.shieldEnergy=1,this.shieldActive=!1,this.shieldRegenCooldown=0,this.respawnTimer=0,this.asteroids=[],this.enemies=[],this.enemySpawnTimer=0,this.playerDeathExploded=!1,this.wave=1,this.waveEnemiesToSpawn=0,this.waveEnemiesRemaining=0,this.waveAsteroidsRemaining=0,this.waveTransitionTimer=0,this.entityManager.clear(),this.particles=new k,this.addEntity(this.particles);const t=this.getSafeSpawnPosition();this.player=new C(t,new z(this.input),this.shipSprite),this.addEntity(this.player),this.startWave(1)}addAsteroid(t,e=!0){e&&(this.waveAsteroidsRemaining+=1),this.asteroids.push(t),this.addEntity(t)}addEnemy(t){this.enemies.push(t),this.addEntity(t)}spawnEnemyAtRandom(){let e=0,i=0;for(let s=0;s<10;s++){e=120+Math.random()*(this.worldSize.x-240),i=120+Math.random()*(this.worldSize.y-240);const o=e-this.player.position.x,n=i-this.player.position.y;if(Math.hypot(o,n)>=this.minEnemySpawnDistance)break}this.addEnemy(new P({x:e,y:i},()=>this.player.position,(s,o)=>this.spawnEnemyBullet(s,o),this.enemySprite,s=>this.events.emit("enemy:destroyed",{position:s})))}startWave(t){this.wave=t,this.waveTransitionTimer=this.waveTransitionDuration,this.enemySpawnTimer=0;const e=2+Math.floor(t/2);this.waveAsteroidsRemaining=0;for(let i=0;i<e;i++)this.spawnAsteroidAtRandom();this.waveEnemiesToSpawn=2+t,this.waveEnemiesRemaining=this.waveEnemiesToSpawn}spawnAsteroidAtRandom(){let e=0,i=0;for(let s=0;s<10;s++){e=160+Math.random()*(this.worldSize.x-320),i=160+Math.random()*(this.worldSize.y-320);const o=e-this.player.position.x,n=i-this.player.position.y;if(Math.hypot(o,n)>=240)break}this.addAsteroid(new x({x:e,y:i},this.getWaveAsteroidSize(),this.onAsteroidDestroyed))}getWaveAsteroidSize(){if(this.wave<2)return Math.random()<.5?"L":"M";if(this.wave<4)return Math.random()<.2?"XL":Math.random()<.5?"L":"M";const t=Math.random();return t<.15?"XL":t<.45?"L":t<.75?"M":"S"}getSafeSpawnPosition(){let e={x:this.worldSize.x/2,y:this.worldSize.y/2};for(let i=0;i<20;i++){const s=200+Math.random()*(this.worldSize.x-400),o=200+Math.random()*(this.worldSize.y-400),n=this.enemies.every(r=>Math.hypot(r.position.x-s,r.position.y-o)>260),a=this.asteroids.every(r=>Math.hypot(r.position.x-s,r.position.y-o)>220);if(n&&a)return{x:s,y:o};e={x:s,y:o}}return e}resolveEnemyOverlaps(){for(let t=0;t<this.enemies.length;t++)for(let e=t+1;e<this.enemies.length;e++){const i=this.enemies[t],s=this.enemies[e],o=s.position.x-i.position.x,n=s.position.y-i.position.y,a=Math.hypot(o,n)||1,r=i.radius+s.radius+4;if(a<r){const d=o/a,c=n/a,l=(r-a)/2;i.position.x-=d*l,i.position.y-=c*l,s.position.x+=d*l,s.position.y+=c*l,i.position.x=Math.max(0,Math.min(i.position.x,this.worldSize.x)),i.position.y=Math.max(0,Math.min(i.position.y,this.worldSize.y)),s.position.x=Math.max(0,Math.min(s.position.x,this.worldSize.x)),s.position.y=Math.max(0,Math.min(s.position.y,this.worldSize.y))}}}getWaveMaxEnemies(){return Math.min(3+Math.floor(this.wave/2),this.maxEnemyCap)}spawnEnemyBullet(t,e){this.addEntity(new ot(t,e)),this.events.emit("shot:enemy",{position:t,angle:e})}updateWaveSpawns(t){if(this.waveTransitionTimer>0){this.waveTransitionTimer=Math.max(0,this.waveTransitionTimer-t);return}this.enemySpawnTimer-=t;const e=this.getWaveMaxEnemies();this.waveEnemiesToSpawn>0&&this.enemies.length<e&&this.enemySpawnTimer<=0&&(this.enemySpawnTimer=this.enemySpawnInterval,this.waveEnemiesToSpawn-=1,this.spawnEnemyAtRandom())}checkWaveComplete(){this.waveTransitionTimer>0||this.waveEnemiesRemaining<=0&&this.waveAsteroidsRemaining<=0&&this.enemies.length===0&&this.asteroids.length===0&&this.startWave(this.wave+1)}onAsteroidDestroyed=t=>{this.events.emit("asteroid:destroyed",{asteroid:t})};emitMuzzleFlash(t,e,i="#ffe6a7"){this.particles.emit({position:t,count:14,life:{min:.12,max:.4},speed:{min:80,max:220},angle:{min:e-18,max:e+18},size:{min:2,max:4},sizeEnd:0,opacity:1,opacityEnd:0,color:{start:i,end:"#ff6b6b"},blendMode:"lighter",shape:"circle"})}emitExplosion(t,e,i,s){this.particles.emit({position:t,count:e,life:{min:.4,max:1},speed:{min:60,max:240},angle:{min:0,max:360},size:{min:2,max:6},sizeEnd:0,opacity:{min:.8,max:1},opacityEnd:0,color:{start:i,end:s},blendMode:"lighter",shape:"circle",spawnShape:"circle",spawnRadius:6})}emitThrusterTrail(){const t=this.player.getAngle()+180,e=t*Math.PI/180,i=this.player.radius*1.1,s={x:this.player.position.x+Math.cos(e)*i,y:this.player.position.y+Math.sin(e)*i};this.particles.emit({position:s,count:3,life:{min:.15,max:.45},speed:{min:20,max:80},angle:{min:t-35,max:t+35},size:{min:1,max:3},sizeEnd:0,opacity:{min:.4,max:.9},opacityEnd:0,color:{start:"#7fd1ff",end:"#326eff"},shape:"circle",drag:.1})}canTogglePause(){const t=this.stateMachine.currentState?.name;return t==="playing"||t==="paused"}onPause(){this.pauseLayer.setVisible(!0)}onResume(){this.pauseLayer.setVisible(!1)}renderLoading(){const t=this.ctx.canvas.width,e=this.ctx.canvas.height;this.ctx.clearRect(0,0,t,e),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,t,e);const i=300,s=16,o=(t-i)/2,n=e/2-s/2;this.ctx.fillStyle="rgba(255,255,255,0.2)",this.ctx.fillRect(o,n,i,s),this.ctx.fillStyle="rgba(120, 196, 255, 0.9)",this.ctx.fillRect(o,n,i*this.progress,s),this.ctx.fillStyle="#ffffff",this.ctx.font=`18px ${this.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.fillText("Loading assets...",t/2,n-10)}}const I=new nt;I.init({selector:"#app",width:800,height:600,backgroundColor:"#000000"});I.start();
