(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();class V{gameTime=0;maxStep=.05;lastTime=0;fps=0;isPaused=!1;tick(){if(this.isPaused)return 0;const t=performance.now();let e=(t-this.lastTime)/1e3;return this.fps=1e3/(t-this.lastTime),this.lastTime=t,e>this.maxStep&&(e=this.maxStep),this.gameTime+=e,e}pause(){this.isPaused=!0}resume(){this.isPaused=!1,this.lastTime=performance.now()}getGameTime(){return this.gameTime}getFPS(){return Math.round(this.fps)}}class O{keys=new Set;justPressed=new Set;justReleased=new Set;onKeyDown=t=>{t.repeat||(this.keys.add(t.key),this.justPressed.add(t.key))};onKeyUp=t=>{this.keys.delete(t.key),this.justReleased.add(t.key)};constructor(){window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp)}dispose(){window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}update(){this.justPressed.clear(),this.justReleased.clear()}isDown(t){return this.keys.has(t)}wasPressed(t){return this.justPressed.has(t)}wasReleased(t){return this.justReleased.has(t)}}class U{entities=[];add(t){this.entities.push(t)}remove(t){this.entities=this.entities.filter(e=>e!==t)}update(t,e){for(const s of this.entities)s.update(t,e);this.handleCollisions(),this.entities=this.entities.filter(s=>s.alive)}render(t){for(const e of this.entities)e.render(t)}clear(){this.entities=[]}handleCollisions(){const t=this.entities.filter(s=>"colliderType"in s),e=s=>typeof s.layer=="number"&&typeof s.mask=="number";for(let s=0;s<t.length;s++)for(let i=s+1;i<t.length;i++){const o=t[s],n=t[i];if(e(o)&&e(n)&&((o.mask&n.layer)===0||(n.mask&o.layer)===0))continue;let a=!1;if(o.colliderType==="circle"&&n.colliderType==="circle"){const h=o.position.x-n.position.x,l=o.position.y-n.position.y;Math.sqrt(h*h+l*l)<o.radius+n.radius&&(a=!0)}else if(o.colliderType==="box"&&n.colliderType==="box")o.position.x<n.position.x+n.width&&o.position.x+o.width>n.position.x&&o.position.y<n.position.y+n.height&&o.position.y+o.height>n.position.y&&(a=!0);else{let h,l;o.colliderType==="circle"?(h=o,l=n):(h=n,l=o);const c=Math.max(l.position.x,Math.min(h.position.x,l.position.x+l.width)),d=Math.max(l.position.y,Math.min(h.position.y,l.position.y+l.height)),u=h.position.x-c,y=h.position.y-d;u*u+y*y<h.radius*h.radius&&(a=!0)}a&&(o.onCollision(n),n.onCollision(o))}}}class ${timer=new V;input=new O;entityManager=new U;isRunning=!1;hasLoopStarted=!1;ctx;uiLayers=[];uiCanvas;uiCtx;uiUpdateIntervalMs=0;uiTimeSinceUpdateMs=0;get screenSize(){return{x:this.ctx.canvas.width,y:this.ctx.canvas.height}}get running(){return this.isRunning}init(t){const e=document.querySelector(t.selector);if(!e)throw new Error(`Element with selector "${t.selector}" not found.`);const s=document.createElement("canvas");s.width=t.width||800,s.height=t.height||600,s.style.backgroundColor=t.backgroundColor||"black",s.id="game",e.appendChild(s),s.focus();const i=s.getContext("2d");if(!i)throw new Error("Failed to get 2D context from canvas.");this.ctx=i,this.onInit()}onInit(){}start(){this.isRunning||(this.isRunning=!0,this.timer.resume(),this.onResume(),this.hasLoopStarted||(this.hasLoopStarted=!0,requestAnimationFrame(this.gameLoop.bind(this))))}stop(){this.isRunning=!1,this.timer.pause(),this.onPause()}onPause(){}onResume(){}canTogglePause(){return!0}gameLoop(){this.input.wasPressed("Escape")&&this.canTogglePause()&&(this.isRunning?this.stop():(this.isRunning=!0,this.timer.resume(),this.onResume()));let t=0;this.isRunning&&(t=this.timer.tick(),this.update(t),this.render());const e=this.isRunning?t:1/60;this.updateAndRenderUI(e),this.input.update(),requestAnimationFrame(this.gameLoop.bind(this))}update(t){this.entityManager.update(t,this.screenSize)}render(t){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.save(),this.entityManager.render(this.ctx),t&&t(),this.ctx.restore()}updateAndRenderUI(t){if(!this.uiCtx||this.uiLayers.length===0||(this.uiTimeSinceUpdateMs+=t*1e3,this.uiUpdateIntervalMs>0&&this.uiTimeSinceUpdateMs<this.uiUpdateIntervalMs))return;this.uiTimeSinceUpdateMs=0;const e=this.uiCanvas.width,s=this.uiCanvas.height;for(const i of this.uiLayers)i.update(t);this.uiCtx.clearRect(0,0,e,s);for(const i of this.uiLayers)i.render(this.uiCtx,e,s)}addUILayer(t){this.uiCtx||this.createUiCanvas(),this.uiLayers.push(t)}removeUILayer(t){this.uiLayers=this.uiLayers.filter(e=>e!==t)}setUiUpdateInterval(t){this.uiUpdateIntervalMs=Math.max(0,t)}createUiCanvas(){const t=this.ctx.canvas.parentElement;if(!t)return;window.getComputedStyle(t).position==="static"&&(t.style.position="relative");const s=document.createElement("canvas");s.width=this.ctx.canvas.width,s.height=this.ctx.canvas.height,s.style.position="absolute",s.style.left="0",s.style.top="0";const i=this.ctx.canvas,o=window.getComputedStyle(i);s.style.width=o.width||i.style.width||"100%",s.style.height=o.height||i.style.height||"100%",s.style.aspectRatio=o.aspectRatio||i.style.aspectRatio||`${i.width} / ${i.height}`,s.style.objectFit=o.objectFit||i.style.objectFit||"contain",s.style.display=o.display||"block",s.style.pointerEvents="none",s.style.zIndex="2",s.id="ui",t.appendChild(s);const n=s.getContext("2d");if(!n)throw new Error("Failed to get 2D context from UI canvas.");this.uiCanvas=s,this.uiCtx=n}addEntity(t){this.entityManager.add(t)}}class v{position;alive;constructor(t={x:0,y:0},e=!0){this.position=t,this.alive=e}}class B{imageQueue=[];images=new Map;taskQueue=[];sounds=new Map;fonts=new Map;queueImage(t,e){this.imageQueue.push({key:t,src:e})}queueSound(t,e,s){this.queueTask("sound",()=>this.loadSound(s,t,e))}queueFont(t,e,s={}){this.queueTask("font",()=>this.loadFont(t,e,s))}queueTask(t,e){this.taskQueue.push({kind:t,run:e})}async loadAll(t){const e=this.imageQueue.length+this.taskQueue.length;let s=0;const i=new Map,o=(d,u)=>{const y=i.get(d)??{loaded:0,total:0};y.total+=u,i.set(d,y)},n=d=>{const u=i.get(d);u&&(u.loaded+=1)};this.imageQueue.length>0&&o("image",this.imageQueue.length);for(const d of this.taskQueue)o(d.kind,1);const a=()=>{const d=e===0?1:s/e,u={};for(const[y,f]of i.entries())u[y]={loaded:f.loaded,total:f.total,percent:f.total===0?1:f.loaded/f.total};t?.({loaded:s,total:e,percent:d,byType:u})};a();const h=this.imageQueue.map(({key:d,src:u})=>this.loadImage(u).then(y=>{this.images.set(d,y),s+=1,n("image"),a()})),l=this.taskQueue.map(({kind:d,run:u})=>u().then(()=>{s+=1,n(d),a()})),c=[...h,...l];await Promise.all(c),this.imageQueue=[],this.taskQueue=[]}getImage(t){const e=this.images.get(t);if(!e)throw new Error(`Image not loaded: ${t}`);return e}getSound(t){const e=this.sounds.get(t);if(!e)throw new Error(`Sound not loaded: ${t}`);return e}getFont(t){const e=this.fonts.get(t);if(!e)throw new Error(`Font not loaded: ${t}`);return e}loadImage(t){return new Promise((e,s)=>{const i=new Image;i.onload=()=>e(i),i.onerror=()=>s(new Error(`Failed to load image: ${t}`)),i.src=t})}async loadSound(t,e,s){const o=await(await fetch(s)).arrayBuffer(),n=await t.decodeAudioData(o);this.sounds.set(e,n)}async loadFont(t,e,s){const o=await new FontFace(t,`url(${e})`,s).load();document.fonts.add(o),this.fonts.set(t,o)}}class q{states=new Map;current;add(t){return this.states.set(t.name,t),this}set(t){const e=this.states.get(t);if(!e)throw new Error(`State not found: ${t}`);const s=this.current;s&&s.name===e.name||(s?.exit?.(e),this.current=e,e.enter?.(s))}update(t){this.current?.update(t)}render(){this.current?.render()}get currentState(){return this.current}}class G{position={x:0,y:0};zoom=1;setPosition(t,e){this.position.x=t,this.position.y=e}move(t,e){this.position.x+=t,this.position.y+=e}follow(t,e,s){const i=e.x/2/this.zoom,o=e.y/2/this.zoom;let n=t.x-i,a=t.y-o;n=Math.max(0,Math.min(n,s.x-e.x/this.zoom)),a=Math.max(0,Math.min(a,s.y-e.y/this.zoom)),this.position.x=n,this.position.y=a}apply(t){t.save(),t.scale(this.zoom,this.zoom),t.translate(-this.position.x,-this.position.y)}unapply(t){t.restore()}}class X{ctx;buffers=new Map;musicSource;musicGain;constructor(){this.ctx=new AudioContext}getContext(){return this.ctx}registerSound(t,e){this.buffers.set(t,e)}async loadSound(t,e){const i=await(await fetch(e)).arrayBuffer(),o=await this.ctx.decodeAudioData(i);this.buffers.set(t,o)}async loadAll(t){await Promise.all(t.map(e=>this.loadSound(e.key,e.src)))}async resume(){this.ctx.state==="suspended"&&await this.ctx.resume()}playSound(t,e=1){const s=this.buffers.get(t);if(!s)return;const i=this.ctx.createBufferSource(),o=this.ctx.createGain();i.buffer=s,o.gain.value=e,i.connect(o).connect(this.ctx.destination),i.start(0)}playMusic(t,e=.6){const s=this.buffers.get(t);if(!s)return;this.stopMusic();const i=this.ctx.createBufferSource(),o=this.ctx.createGain();i.buffer=s,i.loop=!0,o.gain.value=e,i.connect(o).connect(this.ctx.destination),i.start(0),this.musicSource=i,this.musicGain=o}stopMusic(){this.musicSource&&(this.musicSource.stop(),this.musicSource.disconnect(),this.musicSource=void 0,this.musicGain=void 0)}setMusicVolume(t){this.musicGain&&(this.musicGain.gain.value=t)}}class H{listeners={};on(t,e){const s=this.listeners[t]??new Set;return s.add(e),this.listeners[t]=s,()=>this.off(t,e)}off(t,e){const s=this.listeners[t];s&&(s.delete(e),s.size===0&&delete this.listeners[t])}emit(t,e){const s=this.listeners[t];if(s)for(const i of s)i(e)}clear(){this.listeners={}}}const Y=r=>Math.max(0,Math.min(1,r)),j=r=>(r=Y(r),-(Math.cos(Math.PI*r)-1)/2);class Q{systems=[];add(t,e=0){return this.systems.push({system:t,order:e}),this.systems.sort((s,i)=>s.order-i.order),this}remove(t){this.systems=this.systems.filter(e=>e.system!==t)}clear(){this.systems=[]}update(t){for(const e of this.systems)e.system.update(t)}render(){for(const t of this.systems)t.system.render?.()}}const g=(r,t)=>r===void 0?t:typeof r=="number"?r:r.min+Math.random()*(r.max-r.min),b=(r,t,e)=>Math.max(t,Math.min(e,r)),S=(r,t,e)=>r+(t-r)*e,I=r=>{if(!r.startsWith("#"))return null;const t=r.slice(1);if(t.length===3){const e=parseInt(t[0]+t[0],16),s=parseInt(t[1]+t[1],16),i=parseInt(t[2]+t[2],16);return[e,s,i,1]}if(t.length===6||t.length===8){const e=parseInt(t.slice(0,2),16),s=parseInt(t.slice(2,4),16),i=parseInt(t.slice(4,6),16),o=t.length===8?parseInt(t.slice(6,8),16)/255:1;return[e,s,i,o]}return null},K=(r,t,e)=>{const s=I(r),i=I(t);if(!s||!i)return r;const o=Math.round(S(s[0],i[0],e)),n=Math.round(S(s[1],i[1],e)),a=Math.round(S(s[2],i[2],e)),h=S(s[3],i[3],e);return`rgba(${o}, ${n}, ${a}, ${h})`},N=(r,t)=>typeof r=="function"?r(t):typeof r=="string"?r:K(r.start,r.end,t);class Z extends v{particles=[];clear(){this.particles=[]}emit(t){const e=t.count??1,s=t.shape??"circle",i=t.gravity??{x:0,y:0},o=b(t.drag??0,0,1);for(let n=0;n<e;n++){const a=this.getSpawnPosition(t),h=g(t.angle,0)*(Math.PI/180),l=g(t.speed,0),c=Math.max(.01,g(t.life,.6)),d=Math.max(.1,g(t.size,4)),u=Math.max(0,g(t.sizeEnd,d)),y=b(g(t.opacity,1),0,1),f=b(g(t.opacityEnd,0),0,1),w=g(t.rotation,0),C=g(t.angularVelocity,0),T={x:Math.cos(h)*l,y:Math.sin(h)*l};this.particles.push({position:a,velocity:T,age:0,life:c,size:d,sizeEnd:u,opacity:y,opacityEnd:f,rotation:w,angularVelocity:C,color:t.color??"#ffffff",shape:s,sprite:t.sprite,blendMode:t.blendMode,gravity:i,drag:o})}}update(t){for(const e of this.particles){if(e.age+=t,e.age>=e.life){e.opacity=0;continue}e.velocity.x+=e.gravity.x*t,e.velocity.y+=e.gravity.y*t,e.velocity.x*=1-e.drag,e.velocity.y*=1-e.drag,e.position.x+=e.velocity.x*t,e.position.y+=e.velocity.y*t,e.rotation+=e.angularVelocity*t}this.particles=this.particles.filter(e=>e.age<e.life)}render(t){for(const e of this.particles){const s=b(e.age/e.life,0,1),i=S(e.size,e.sizeEnd,s),o=S(e.opacity,e.opacityEnd,s);if(o<=0||i<=0)continue;t.save(),e.blendMode&&(t.globalCompositeOperation=e.blendMode),t.globalAlpha=o,t.translate(e.position.x,e.position.y),t.rotate(e.rotation);const n=N(e.color,s);if(e.shape==="sprite"&&e.sprite){const a=i*2,h=i*2;t.drawImage(e.sprite,-a/2,-h/2,a,h)}else e.shape==="square"?(t.fillStyle=n,t.fillRect(-i/2,-i/2,i,i)):e.shape==="triangle"?(t.fillStyle=n,t.beginPath(),t.moveTo(0,-i),t.lineTo(i,i),t.lineTo(-i,i),t.closePath(),t.fill()):e.shape==="line"?(t.strokeStyle=n,t.lineWidth=Math.max(1,i*.35),t.beginPath(),t.moveTo(-i,0),t.lineTo(i,0),t.stroke()):(t.fillStyle=n,t.beginPath(),t.arc(0,0,i,0,Math.PI*2),t.fill());t.restore()}}getSpawnPosition(t){const e=t.spawnShape??"point",s=t.position;if(e==="circle"){const i=t.spawnRadius??4,o=Math.random()*Math.PI*2,n=Math.random()*i;return{x:s.x+Math.cos(o)*n,y:s.y+Math.sin(o)*n}}if(e==="rect"){const i=t.spawnWidth??8,o=t.spawnHeight??8;return{x:s.x+(Math.random()-.5)*i,y:s.y+(Math.random()-.5)*o}}return{x:s.x,y:s.y}}}class M{anchor;offsetX;offsetY;parent;constructor(t={}){this.anchor=t.anchor??"top-left",this.offsetX=t.offsetX??0,this.offsetY=t.offsetY??0,this.parent=t.parent??null}update(t){}getAnchorPoint(t,e){switch(this.anchor){case"top-left":return{x:0,y:0};case"top-right":return{x:t,y:0};case"bottom-left":return{x:0,y:e};case"bottom-right":return{x:t,y:e};case"center":return{x:t/2,y:e/2}}}getLocalPosition(t,e){const s=this.getAnchorPoint(t,e);return{x:s.x+this.offsetX,y:s.y+this.offsetY}}}class k{name;visible=!0;elements=[];constructor(t){this.name=t}add(t){this.elements.push(t)}remove(t){this.elements=this.elements.filter(e=>e!==t)}setVisible(t){this.visible=t}update(t){if(this.visible)for(const e of this.elements)e.update(t)}render(t,e,s){if(this.visible)for(const i of this.elements)i.render(t,e,s)}}class P extends M{width;height;backgroundColor;borderColor;borderWidth;borderRadius;children=[];constructor(t){super(t),this.width=t.width,this.height=t.height,this.backgroundColor=t.backgroundColor??"rgba(0,0,0,0.5)",this.borderColor=t.borderColor??"rgba(255,255,255,0.2)",this.borderWidth=t.borderWidth??0,this.borderRadius=t.borderRadius??0}add(t){t.parent=this,this.children.push(t)}update(t){for(const e of this.children)e.update(t)}render(t,e,s){const i=this.getLocalPosition(e,s);t.save(),t.translate(i.x,i.y);const o=Math.max(0,Math.min(this.borderRadius,Math.min(this.width,this.height)/2));o>0?(t.beginPath(),t.moveTo(o,0),t.lineTo(this.width-o,0),t.quadraticCurveTo(this.width,0,this.width,o),t.lineTo(this.width,this.height-o),t.quadraticCurveTo(this.width,this.height,this.width-o,this.height),t.lineTo(o,this.height),t.quadraticCurveTo(0,this.height,0,this.height-o),t.lineTo(0,o),t.quadraticCurveTo(0,0,o,0),t.closePath(),t.fillStyle=this.backgroundColor,t.fill(),this.borderWidth>0&&(t.strokeStyle=this.borderColor,t.lineWidth=this.borderWidth,t.stroke())):(t.fillStyle=this.backgroundColor,t.fillRect(0,0,this.width,this.height),this.borderWidth>0&&(t.strokeStyle=this.borderColor,t.lineWidth=this.borderWidth,t.strokeRect(0,0,this.width,this.height)));for(const n of this.children)n.render(t,this.width,this.height);t.restore()}}class J extends M{getScore;color;font;constructor(t){super(t),this.getScore=t.getScore,this.color=t.color??"#ffffff",this.font=t.font??"16px sans-serif"}render(t,e,s){const i=this.getLocalPosition(e,s);t.save(),t.font=this.font,t.fillStyle=this.color,t.textAlign=this.anchor==="center"?"center":this.anchor.endsWith("right")?"right":"left",t.textBaseline=this.anchor==="center"?"middle":"top",t.fillText(`SCORE: ${this.getScore()}`,i.x,i.y),t.restore()}}class _ extends M{getText;color;font;constructor(t){super(t),this.getText=t.getText,this.color=t.color??"#ffffff",this.font=t.font??"18px sans-serif"}render(t,e,s){const i=this.getLocalPosition(e,s);t.save(),t.font=this.font,t.fillStyle=this.color,t.textAlign=this.anchor==="center"?"center":this.anchor.endsWith("right")?"right":"left",t.textBaseline=this.anchor==="center"?"middle":"top",t.fillText(this.getText(),i.x,i.y),t.restore()}}class tt extends M{getValue;width;height;backgroundColor;fillColor;borderColor;borderWidth;constructor(t){super(t),this.getValue=t.getValue,this.width=t.width,this.height=t.height,this.backgroundColor=t.backgroundColor??"rgba(0,0,0,0.5)",this.fillColor=t.fillColor??"#5ac8fa",this.borderColor=t.borderColor??"rgba(255,255,255,0.3)",this.borderWidth=t.borderWidth??1}render(t,e,s){const i=this.getLocalPosition(e,s),o=Math.max(0,Math.min(1,this.getValue()));t.save(),t.translate(i.x,i.y),this.anchor.endsWith("right")?t.translate(-this.width,0):this.anchor==="center"&&t.translate(-this.width/2,0),t.fillStyle=this.backgroundColor,t.fillRect(0,0,this.width,this.height),t.fillStyle=this.fillColor,t.fillRect(0,0,this.width*o,this.height),this.borderWidth>0&&(t.strokeStyle=this.borderColor,t.lineWidth=this.borderWidth,t.strokeRect(0,0,this.width,this.height)),t.restore()}}class z{input;constructor(t){this.input=t}getRotation(){return this.input.isDown("ArrowLeft")?-1:this.input.isDown("ArrowRight")?1:0}isThrusting(){return this.input.isDown("ArrowUp")}}const p={Player:1,PlayerBullet:2,Enemy:4,EnemyBullet:8,Asteroid:16};class A extends v{radius=2;colliderType="circle";layer=p.PlayerBullet;mask=p.Enemy|p.Asteroid;velocity;constructor(t,e,s=400){super(t);const i=e*Math.PI/180;this.velocity={x:Math.cos(i)*s,y:Math.sin(i)*s}}update(t,e){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,(this.position.x<0||this.position.x>e.x||this.position.y<0||this.position.y>e.y)&&(this.alive=!1)}render(t){t.save(),t.translate(this.position.x,this.position.y),t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle="#ffff00",t.fill(),t.restore()}onCollision(t){this.alive=!1}}const et={XL:48,L:32,M:22,S:14},st={XL:"L",L:"M",M:"S",S:null},it={XL:20,L:50,M:100,S:200};class x extends v{radius;colliderType="circle";layer=p.Asteroid;mask=p.Player|p.PlayerBullet|p.Asteroid;size;angle;rotationSpeed;velocity;shapePoints;shouldSplit=!1;hasSplit=!1;onDestroyed;hasScored=!1;constructor(t,e="L",s){super(t),this.size=e,this.radius=et[e],this.onDestroyed=s,this.angle=Math.random()*360,this.rotationSpeed=(Math.random()-.5)*90;const i=50+Math.random()*100,o=Math.random()*Math.PI*2;this.velocity={x:Math.cos(o)*i,y:Math.sin(o)*i};const n=8;this.shapePoints=Array.from({length:n},(a,h)=>({angle:h*Math.PI*2/n,scale:.75+Math.random()*.5}))}update(t,e){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t;const s=e.x,i=e.y;(this.position.x<0||this.position.x>s)&&(this.velocity.x*=-1,this.position.x=Math.max(0,Math.min(this.position.x,s))),(this.position.y<0||this.position.y>i)&&(this.velocity.y*=-1,this.position.y=Math.max(0,Math.min(this.position.y,i))),this.angle+=this.rotationSpeed*t}render(t){const e=this.radius;t.save(),t.translate(this.position.x,this.position.y),t.rotate(this.angle*Math.PI/180),t.beginPath();const s=this.shapePoints[0];t.moveTo(Math.cos(s.angle)*e*s.scale,Math.sin(s.angle)*e*s.scale);for(let i=1;i<this.shapePoints.length;i++){const o=this.shapePoints[i];t.lineTo(Math.cos(o.angle)*e*o.scale,Math.sin(o.angle)*e*o.scale)}t.closePath(),t.strokeStyle="#ffffff",t.lineWidth=2,t.stroke(),t.restore()}setVelocity(t){this.velocity=t}getVelocity(){return{x:this.velocity.x,y:this.velocity.y}}setPosition(t){this.position=t}split(){if(!this.shouldSplit||this.hasSplit)return[];this.hasSplit=!0;const t=st[this.size];if(!t)return[];const e=this.radius*.8,s=Math.random()*Math.PI*2,i=Math.cos(s)*e,o=Math.sin(s)*e,n=new x({x:this.position.x+i,y:this.position.y+o},t,this.onDestroyed),a=new x({x:this.position.x-i,y:this.position.y-o},t,this.onDestroyed);return n.setVelocity({x:this.velocity.x+i*2,y:this.velocity.y+o*2}),a.setVelocity({x:this.velocity.x-i*2,y:this.velocity.y-o*2}),[n,a]}getScoreValue(){return it[this.size]}onCollision(t){if(t instanceof A){this.hasScored||(this.hasScored=!0,this.onDestroyed?.(this)),this.shouldSplit=!0,this.alive=!1;return}t instanceof x&&x.resolveCollision(this,t)}static resolveCollision(t,e){const s=e.position.x-t.position.x,i=e.position.y-t.position.y,o=Math.hypot(s,i)||1,n=s/o,a=i/o,h=t.radius+e.radius-o;if(h>0){const w=h/2;t.position.x-=n*w,t.position.y-=a*w,e.position.x+=n*w,e.position.y+=a*w}const l=e.velocity.x-t.velocity.x,c=e.velocity.y-t.velocity.y,d=l*n+c*a;if(d>0)return;const u=-1.9*d/2,y=u*n,f=u*a;t.velocity.x-=y,t.velocity.y-=f,e.velocity.x+=y,e.velocity.y+=f}}class E extends v{radius=18;colliderType="circle";layer=p.Enemy;mask=p.Player|p.PlayerBullet;sprite;speed=80;angle=0;shootCooldown=0;fireInterval=3.2;getTarget;onShoot;onDestroyed;hasScored=!1;constructor(t,e,s,i,o){super(t),this.getTarget=e,this.onShoot=s,this.sprite=i,this.onDestroyed=o}update(t,e){const s=this.getTarget(),i=s.x-this.position.x,o=s.y-this.position.y,n=Math.hypot(i,o)||1,a=i/n,h=o/n;this.position.x+=a*this.speed*t,this.position.y+=h*this.speed*t,this.position.x=Math.max(0,Math.min(this.position.x,e.x)),this.position.y=Math.max(0,Math.min(this.position.y,e.y)),this.angle=Math.atan2(o,i)*180/Math.PI,this.shootCooldown-=t,this.shootCooldown<=0&&(this.shootCooldown=this.fireInterval,this.onShoot({x:this.position.x,y:this.position.y},this.angle))}render(t){if(t.save(),t.translate(this.position.x,this.position.y),t.rotate(this.angle*Math.PI/180),this.sprite){t.rotate(Math.PI/2);const e=this.radius*2.4/this.sprite.width,s=this.sprite.width*e,i=this.sprite.height*e;t.drawImage(this.sprite,-s/2,-i/2,s,i)}else t.fillStyle="#ff6b6b",t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fill();t.restore()}onCollision(t){t instanceof E||t instanceof A&&(this.hasScored||(this.hasScored=!0,this.onDestroyed?.({x:this.position.x,y:this.position.y})),this.alive=!1)}}class R extends v{radius=15;colliderType="circle";layer=p.Player;mask=p.Enemy|p.EnemyBullet|p.Asteroid;angle=0;velocity={x:0,y:0};thrust=0;friction=.98;sprite;shieldActive=!1;get controller(){return this._controller}_controller;constructor(t,e,s){super(t),this._controller=e,this.sprite=s}setShieldActive(t){this.shieldActive=t}isShieldActive(){return this.shieldActive}isThrusting(){return this.controller.isThrusting()}update(t,e){this.angle+=this.controller.getRotation()*180*t,this.controller.isThrusting()?this.thrust=200:this.thrust=0,this.velocity.x+=Math.cos(this.angle*Math.PI/180)*this.thrust*t,this.velocity.y+=Math.sin(this.angle*Math.PI/180)*this.thrust*t,this.velocity.x*=this.friction,this.velocity.y*=this.friction,this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t;const s=e.x,i=e.y;this.position.x<0&&(this.position.x+=s),this.position.x>s&&(this.position.x-=s),this.position.y<0&&(this.position.y+=i),this.position.y>i&&(this.position.y-=i)}render(t){if(t.save(),t.translate(this.position.x,this.position.y),this.shieldActive&&(t.save(),t.beginPath(),t.arc(0,0,this.radius*1.7,0,Math.PI*2),t.strokeStyle="rgba(90, 200, 250, 0.9)",t.lineWidth=2,t.stroke(),t.restore()),t.rotate(this.angle*Math.PI/180),this.sprite){t.rotate(Math.PI/2);const e=this.radius*2.4/this.sprite.width,s=this.sprite.width*e,i=this.sprite.height*e;t.drawImage(this.sprite,-s/2,-i/2,s,i)}else{const s=this.radius*1.3;t.beginPath(),t.moveTo(s,0),t.lineTo(-s*.6,-s*.6),t.lineTo(-s*.3,0),t.lineTo(-s*.6,s*.6),t.closePath(),t.strokeStyle="#ffffff",t.lineWidth=2,t.lineJoin="round",t.stroke()}t.restore()}getAngle(){return this.angle}getSpeed(){return Math.hypot(this.velocity.x,this.velocity.y)}onCollision(t){if(this.shieldActive&&t instanceof E){t.alive=!1;return}if(this.shieldActive&&t instanceof x){const e=t.position.x-this.position.x,s=t.position.y-this.position.y,i=Math.hypot(e,s)||1,o=e/i,n=s/i,a=Math.hypot(t.getVelocity().x,t.getVelocity().y)||120;t.setVelocity({x:o*a,y:n*a}),t.position.x+=o*(t.radius+this.radius),t.position.y+=n*(t.radius+this.radius);return}this.shieldActive||(this.alive=!1)}}class ot extends v{radius=3;colliderType="circle";layer=p.EnemyBullet;mask=p.Player;velocity;constructor(t,e,s=260){super(t);const i=e*Math.PI/180;this.velocity={x:Math.cos(i)*s,y:Math.sin(i)*s}}update(t,e){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,(this.position.x<0||this.position.x>e.x||this.position.y<0||this.position.y>e.y)&&(this.alive=!1)}render(t){t.save(),t.translate(this.position.x,this.position.y),t.beginPath(),t.arc(0,0,this.radius,0,Math.PI*2),t.fillStyle="#ff3b30",t.fill(),t.restore()}onCollision(t){if(t instanceof R){if(t.isShieldActive()){this.alive=!1;return}t.alive=!1,this.alive=!1}}}const m={world:{width:2400,height:1800},shield:{drainRate:.35,regenRate:.2,regenDelay:3},enemy:{spawnInterval:2.5,minSpawnDistance:300,maxCap:20},respawn:{delay:2.5},waves:{transitionDuration:2}};class nt{wave=1;enemiesToSpawn=0;enemiesRemaining=0;asteroidsRemaining=0;spawnTimer=0;transitionTimer=0;enemySpawnInterval;maxEnemyCap;waveTransitionDuration;getEnemyCount;getAsteroidCount;spawnEnemy;spawnAsteroid;constructor(t){this.enemySpawnInterval=t.enemySpawnInterval,this.maxEnemyCap=t.maxEnemyCap,this.waveTransitionDuration=t.waveTransitionDuration,this.getEnemyCount=t.getEnemyCount,this.getAsteroidCount=t.getAsteroidCount,this.spawnEnemy=t.spawnEnemy,this.spawnAsteroid=t.spawnAsteroid}reset(){this.wave=1,this.enemiesToSpawn=0,this.enemiesRemaining=0,this.asteroidsRemaining=0,this.spawnTimer=0,this.transitionTimer=0,this.startWave(1)}update(t){if(this.transitionTimer>0){this.transitionTimer=Math.max(0,this.transitionTimer-t);return}this.spawnTimer-=t;const e=this.getWaveMaxEnemies();this.enemiesToSpawn>0&&this.getEnemyCount()<e&&this.spawnTimer<=0&&(this.spawnTimer=this.enemySpawnInterval,this.enemiesToSpawn-=1,this.spawnEnemy()),this.checkComplete()}onEnemyDestroyed(){this.enemiesRemaining=Math.max(0,this.enemiesRemaining-1)}onAsteroidDestroyed(){this.asteroidsRemaining=Math.max(0,this.asteroidsRemaining-1)}registerWaveAsteroid(){this.asteroidsRemaining+=1}get isTransitioning(){return this.transitionTimer>0}get currentWave(){return this.wave}pickAsteroidSize(){if(this.wave<2)return Math.random()<.5?"L":"M";if(this.wave<4)return Math.random()<.2?"XL":Math.random()<.5?"L":"M";const t=Math.random();return t<.15?"XL":t<.45?"L":t<.75?"M":"S"}startWave(t){this.wave=t,this.transitionTimer=this.waveTransitionDuration,this.spawnTimer=0;const e=2+Math.floor(t/2);this.asteroidsRemaining=0;for(let s=0;s<e;s++)this.spawnAsteroid(this.pickAsteroidSize());this.enemiesToSpawn=2+t,this.enemiesRemaining=this.enemiesToSpawn}checkComplete(){this.transitionTimer>0||this.enemiesRemaining<=0&&this.asteroidsRemaining<=0&&this.getEnemyCount()===0&&this.getAsteroidCount()===0&&this.startWave(this.wave+1)}getWaveMaxEnemies(){return Math.min(3+Math.floor(this.wave/2),this.maxEnemyCap)}}class at{score=0;getWave;constructor(t){this.getWave=t}reset(){this.score=0}update(){}getScore(){return this.score}onAsteroidDestroyed(t){this.score+=t.getScoreValue()}onEnemyDestroyed(){this.score+=10*this.getWave()}}class rt{audio;particles;constructor(t,e){this.audio=t,this.particles=e}update(){}bind(t){t.on("shot:player",({position:e,angle:s})=>{this.audio.playSound("lazerShoot",.6),this.emitMuzzleFlash(e,s)}),t.on("shot:enemy",({position:e,angle:s})=>{this.audio.playSound("laserShootEnemy",.7),this.emitMuzzleFlash(e,s,"#ff8b8b")}),t.on("asteroid:destroyed",({asteroid:e})=>{this.audio.playSound("explosion",.7),this.emitExplosion(e.position,26,"#ffffff","#ff9a7a")}),t.on("enemy:destroyed",({position:e})=>{this.audio.playSound("explosion",.7),this.emitExplosion(e,22,"#ff6b6b","#ffd3a3")}),t.on("player:destroyed",({position:e})=>{this.audio.playSound("explosion",.7),this.emitExplosion(e,30,"#7fd1ff","#ffffff")})}emitThrusterTrail(t,e,s){const i=e*Math.PI/180,o=s*1.1,n={x:t.x+Math.cos(i)*o,y:t.y+Math.sin(i)*o};this.particles.emit({position:n,count:3,life:{min:.15,max:.45},speed:{min:20,max:80},angle:{min:e-35,max:e+35},size:{min:1,max:3},sizeEnd:0,opacity:{min:.4,max:.9},opacityEnd:0,color:{start:"#7fd1ff",end:"#326eff"},shape:"circle",drag:.1})}emitMuzzleFlash(t,e,s="#ffe6a7"){this.particles.emit({position:t,count:14,life:{min:.12,max:.4},speed:{min:80,max:220},angle:{min:e-18,max:e+18},size:{min:2,max:4},sizeEnd:0,opacity:1,opacityEnd:0,color:{start:s,end:"#ff6b6b"},blendMode:"lighter",shape:"circle"})}emitExplosion(t,e,s,i){this.particles.emit({position:t,count:e,life:{min:.4,max:1},speed:{min:60,max:240},angle:{min:0,max:360},size:{min:2,max:6},sizeEnd:0,opacity:{min:.8,max:1},opacityEnd:0,color:{start:s,end:i},blendMode:"lighter",shape:"circle",spawnShape:"circle",spawnRadius:6})}}class ht extends M{getLives;maxLives;color;size;spacing;constructor(t){super(t),this.getLives=t.getLives,this.maxLives=t.maxLives??3,this.color=t.color??"#00ff6a",this.size=t.size??12,this.spacing=t.spacing??8}render(t,e,s){const i=this.getLocalPosition(e,s),o=Math.max(0,Math.min(this.getLives(),this.maxLives));t.save(),t.translate(i.x,i.y);const n=o>0?o*this.size+(o-1)*this.spacing:0,a=this.anchor==="center"?-n/2:this.anchor.endsWith("right")?-n:0,h=this.anchor==="center"?this.size*.15:0;for(let l=0;l<o;l++){const c=a+l*(this.size+this.spacing)+this.size/2;this.drawShip(t,c,h)}t.restore()}drawShip(t,e,s){const i=this.size;t.save(),t.translate(e,s),t.beginPath(),t.moveTo(0,-i),t.lineTo(-i*.6,i*.7),t.lineTo(0,i*.3),t.lineTo(i*.6,i*.7),t.closePath(),t.strokeStyle=this.color,t.lineWidth=2,t.lineJoin="round",t.stroke(),t.restore()}}class lt extends M{getAsteroids;getEnemies;getPlayer;getWorldSize;width;height;asteroidColor;enemyColor;playerColor;dotRadius;constructor(t){super(t),this.getAsteroids=t.getAsteroids,this.getEnemies=t.getEnemies,this.getPlayer=t.getPlayer,this.getWorldSize=t.getWorldSize,this.width=t.width,this.height=t.height,this.asteroidColor=t.asteroidColor??"#ffffff",this.enemyColor=t.enemyColor??"#ff3b30",this.playerColor=t.playerColor??"#3da5ff",this.dotRadius=t.dotRadius??2}render(t,e,s){const i=this.getLocalPosition(e,s),o=8,n=this.width-o*2,a=this.height-o*2,h=this.getWorldSize(),l=this.getPlayer();if(!l)return;t.save(),t.translate(i.x,i.y),t.beginPath(),t.rect(0,0,this.width,this.height),t.clip();const c=(d,u)=>{const y=d.position.x-l.x,f=d.position.y-l.y,w=h.x>0?y/h.x:0,C=h.y>0?f/h.y:0,T=o+n/2+w*n,D=o+a/2+C*a,W=Math.max(o,Math.min(T,o+n)),F=Math.max(o,Math.min(D,o+a));t.fillStyle=u,t.beginPath(),t.arc(W,F,this.dotRadius,0,Math.PI*2),t.fill()};for(const d of this.getAsteroids())c(d,this.asteroidColor);for(const d of this.getEnemies())c(d,this.enemyColor);t.fillStyle=this.playerColor,t.beginPath(),t.arc(o+n/2,o+a/2,this.dotRadius+.5,0,Math.PI*2),t.fill(),t.restore()}}class dt{options;hudLayer=new k("HUD");pauseLayer=new k("Pause");constructor(t){this.options=t}init(){const{width:t}=this.options.getCanvasSize(),e=new P({anchor:"top-left",offsetX:(t-160)/2,offsetY:10,width:160,height:40,backgroundColor:"rgba(0,0,0,0.6)"}),s=new J({getScore:()=>this.options.getScore(),anchor:"center",offsetX:0,offsetY:0,parent:e,font:`16px ${this.options.fontFamily}`});e.add(s),this.hudLayer.add(e);const i=new P({anchor:"top-left",offsetX:(t-160)/2,offsetY:56,width:160,height:90,backgroundColor:"rgba(0,0,0,0.5)",borderColor:"rgba(255,255,255,0.2)",borderWidth:1,borderRadius:8}),o=new lt({getAsteroids:()=>this.options.getAsteroids(),getEnemies:()=>this.options.getEnemies(),getPlayer:()=>this.options.getPlayer(),getWorldSize:()=>this.options.getWorldSize(),width:160,height:90,anchor:"top-left",parent:i,offsetX:0,offsetY:0,asteroidColor:"#ffffff",enemyColor:"#ff3b30",playerColor:"#3da5ff",dotRadius:1.5});i.add(o),this.hudLayer.add(i);const n=new P({anchor:"top-right",offsetX:-150,offsetY:10,width:140,height:40,backgroundColor:"rgba(0,0,0,0.4)",borderWidth:0}),a=new ht({getLives:()=>this.options.getLives(),maxLives:3,anchor:"center",parent:n,color:"#00ff6a",size:10,spacing:10});n.add(a),this.hudLayer.add(n);const h=new tt({getValue:()=>this.options.getShield(),width:120,height:10,anchor:"top-left",offsetX:20,offsetY:20,backgroundColor:"rgba(0,0,0,0.5)",fillColor:(this.options.getShieldActive(),"#5ac8fa"),borderColor:"rgba(255,255,255,0.25)",borderWidth:1});this.hudLayer.add(h);const l=new P({anchor:"center",offsetX:-120,offsetY:-35,width:240,height:70,backgroundColor:"rgba(28, 54, 92, 0.9)",borderColor:"rgba(120, 196, 255, 0.9)",borderWidth:3,borderRadius:16}),c=new _({getText:()=>"PAUSED",anchor:"center",parent:l,offsetY:0,color:"rgba(120, 196, 255, 0.9)",font:`28px ${this.options.fontFamily}`});l.add(c),this.pauseLayer.add(l),this.pauseLayer.setVisible(!1),this.options.addLayer(this.hudLayer),this.options.addLayer(this.pauseLayer)}setHudVisible(t){this.hudLayer.setVisible(t)}setPauseVisible(t){this.pauseLayer.setVisible(t)}update(){}}class ct extends ${assets=new B;audio=new X;camera=new G;particles=new Z;events=new H;worldSize={x:m.world.width,y:m.world.height};systems=new Q;waveSystem;scoreSystem;effectsSystem;progress=0;shipSprite;enemySprite;lives=3;shieldEnergy=1;shieldActive=!1;shieldDrainRate=m.shield.drainRate;shieldRegenRate=m.shield.regenRate;shieldRegenDelay=m.shield.regenDelay;shieldRegenCooldown=0;hudSystem;player;asteroids=[];enemies=[];enemySpawnInterval=m.enemy.spawnInterval;minEnemySpawnDistance=m.enemy.minSpawnDistance;maxEnemyCap=m.enemy.maxCap;respawnDelay=m.respawn.delay;respawnTimer=0;playerDeathExploded=!1;menuPulseTime=0;stateMachine=new q;menuStars=[];gameOverTime=0;fontFamily='"Space Grotesk", sans-serif';get screenSize(){return this.worldSize}get viewportSize(){return{x:this.ctx.canvas.width,y:this.ctx.canvas.height}}onInit(){this.setUiUpdateInterval(100),this.setupSystems(),this.setupEvents(),this.setupMenuStars(),this.setupStates(),this.stateMachine.set("loading")}update(t){this.stateMachine.update(t)}render(){this.stateMachine.render()}updatePlaying(t){this.shieldActive=this.input.isDown("ArrowDown")&&this.shieldEnergy>0;const e=this.player.isThrusting();if(this.input.wasPressed(" ")){const c=this.player.getAngle(),d=c*Math.PI/180,u=this.player.radius*1.2,y={x:this.player.position.x+Math.cos(d)*u,y:this.player.position.y+Math.sin(d)*u};this.addEntity(new A(y,c)),this.events.emit("shot:player",{position:y,angle:c})}if(super.update(t),this.systems.update(t),e&&this.effectsSystem.emitThrusterTrail(this.player.position,this.player.getAngle()+180,this.player.radius),this.shieldActive?(this.shieldEnergy=Math.max(0,this.shieldEnergy-this.shieldDrainRate*t),this.shieldEnergy===0&&(this.shieldRegenCooldown=this.shieldRegenDelay)):this.shieldRegenCooldown>0?this.shieldRegenCooldown=Math.max(0,this.shieldRegenCooldown-t):this.shieldEnergy=Math.min(1,this.shieldEnergy+this.shieldRegenRate*t),this.player.setShieldActive(this.shieldActive),!this.player.alive&&(this.playerDeathExploded||(this.playerDeathExploded=!0,this.events.emit("player:destroyed",{position:this.player.position})),this.lives>0&&(this.lives-=1,this.lives>0))){this.respawnTimer=this.respawnDelay,this.stateMachine.set("respawn");return}const s=[];this.asteroids=this.asteroids.filter(c=>c.alive?!0:(s.push(...c.split()),!1));for(const c of s)this.addAsteroid(c);this.enemies=this.enemies.filter(c=>c.alive),this.resolveEnemyOverlaps();const i=this.player.getSpeed(),o=.75,n=1.2,h=Math.max(0,Math.min(1,i/180)),l=n-(n-o)*h;this.camera.zoom+=(l-this.camera.zoom)*Math.min(1,t*6),this.camera.follow(this.player.position,this.viewportSize,this.worldSize)}renderPlaying(){this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.camera.apply(this.ctx),this.ctx.fillStyle="#0b0f1a",this.ctx.fillRect(0,0,this.worldSize.x,this.worldSize.y),this.ctx.strokeStyle="rgba(255,255,255,0.08)",this.ctx.lineWidth=1;const t=200;for(let e=0;e<=this.worldSize.x;e+=t)this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.worldSize.y),this.ctx.stroke();for(let e=0;e<=this.worldSize.y;e+=t)this.ctx.beginPath(),this.ctx.moveTo(0,e),this.ctx.lineTo(this.worldSize.x,e),this.ctx.stroke();this.entityManager.render(this.ctx),this.ctx.strokeStyle="rgba(255,255,255,0.2)",this.ctx.lineWidth=2,this.ctx.strokeRect(0,0,this.worldSize.x,this.worldSize.y),this.camera.unapply(this.ctx),this.waveSystem.isTransitioning&&this.renderCenterOverlay(`Wave ${this.waveSystem.currentWave}`,"Prepare for battle")}renderTextScreen(t,e){const s=this.ctx.canvas.width,i=this.ctx.canvas.height;this.ctx.clearRect(0,0,s,i),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,s,i),this.ctx.fillStyle="#ffffff",this.ctx.font='36px "Space Grotesk", sans-serif',this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t,s/2,i/2-20),e&&(this.ctx.fillStyle="rgba(255,255,255,0.8)",this.ctx.font='18px "Space Grotesk", sans-serif',this.ctx.fillText(e,s/2,i/2+20))}renderTitleScreen(){const t=this.ctx.canvas.width,e=this.ctx.canvas.height;this.ctx.clearRect(0,0,t,e),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,t,e),this.renderMenuStars(t,e,this.menuPulseTime),this.ctx.font=`56px ${this.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.lineWidth=3,this.ctx.strokeStyle="rgba(180,180,180,0.9)",this.ctx.strokeText("Orbital Drift",t/2,e/2-28),this.ctx.fillStyle="#ffffff",this.ctx.fillText("Orbital Drift",t/2,e/2-28);const s=(Math.sin(this.menuPulseTime*Math.PI*1.2)+1)/2,i=.25+.75*j(s);this.ctx.fillStyle=`rgba(255,255,255,${i.toFixed(3)})`,this.ctx.font=`18px ${this.fontFamily}`,this.ctx.fillText("Press Enter to Start",t/2,e/2+28)}renderGameOver(){const t=this.ctx.canvas.width,e=this.ctx.canvas.height;this.renderPlaying();const s=Math.max(0,Math.min(1,this.gameOverTime/1.2));this.ctx.save(),this.ctx.fillStyle=`rgba(0,0,0,${(.85*s).toFixed(3)})`,this.ctx.fillRect(0,0,t,e);const i=Math.max(0,Math.min(1,(this.gameOverTime-.2)/1));this.ctx.fillStyle=`rgba(255,255,255,${i.toFixed(3)})`,this.ctx.font=`36px ${this.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("Game Over",t/2,e/2-20),this.ctx.font=`18px ${this.fontFamily}`,this.ctx.fillText(`Score: ${this.scoreSystem.getScore()}`,t/2,e/2+15),this.ctx.restore()}setupMenuStars(){this.menuStars=Array.from({length:90},()=>({x:Math.random(),y:Math.random(),speed:.02+Math.random()*.08,size:.6+Math.random()*1.4}))}renderMenuStars(t,e,s){this.ctx.save();for(const i of this.menuStars){const o=(i.y+s*i.speed)%1,n=i.x*t,a=o*e,h=.35+.65*(.5+.5*Math.sin(s*2+i.x*12));this.ctx.fillStyle=`rgba(120, 196, 255, ${h.toFixed(3)})`,this.ctx.beginPath(),this.ctx.arc(n,a,i.size,0,Math.PI*2),this.ctx.fill()}this.ctx.restore()}renderCenterOverlay(t,e){const s=this.ctx.canvas.width,i=this.ctx.canvas.height;this.ctx.save(),this.ctx.fillStyle="rgba(0,0,0,0.35)",this.ctx.fillRect(0,0,s,i),this.ctx.fillStyle="#ffffff",this.ctx.font=`32px ${this.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(t,s/2,i/2-18),e&&(this.ctx.fillStyle="rgba(255,255,255,0.8)",this.ctx.font=`18px ${this.fontFamily}`,this.ctx.fillText(e,s/2,i/2+18)),this.ctx.restore()}setupUi(){this.hudSystem=new dt({getScore:()=>this.scoreSystem.getScore(),getLives:()=>this.lives,getShield:()=>this.shieldEnergy,getShieldActive:()=>this.shieldActive,getAsteroids:()=>this.asteroids,getEnemies:()=>this.enemies,getWorldSize:()=>this.worldSize,getPlayer:()=>this.player?.position,getCanvasSize:()=>({width:this.ctx.canvas.width,height:this.ctx.canvas.height}),addLayer:t=>this.addUILayer(t),fontFamily:this.fontFamily}),this.hudSystem.init()}setupStates(){const t={name:"loading",enter:()=>{this.hudSystem.setHudVisible(!1);const a=this.audio.getContext();this.assets.queueSound("doomed","/Alexander Ehlers - Doomed.mp3",a),this.assets.queueSound("flags","/Alexander Ehlers - Flags.mp3",a),this.assets.queueSound("lazerShoot","/laserShoot.wav",a),this.assets.queueSound("laserShootEnemy","/laserShootEnemy.wav",a),this.assets.queueSound("explosion","/explosion.wav",a),this.assets.queueFont("Space Grotesk","/Space_Grotesk/SpaceGrotesk-VariableFont_wght.ttf"),this.assets.queueImage("ship","/spaceship.png"),this.assets.queueImage("enemy","/enemy.png"),this.assets.loadAll(h=>{this.progress=h.percent}).then(()=>{this.shipSprite=this.assets.getImage("ship"),this.enemySprite=this.assets.getImage("enemy"),this.audio.registerSound("doomed",this.assets.getSound("doomed")),this.audio.registerSound("flags",this.assets.getSound("flags")),this.audio.registerSound("lazerShoot",this.assets.getSound("lazerShoot")),this.audio.registerSound("laserShootEnemy",this.assets.getSound("laserShootEnemy")),this.audio.registerSound("explosion",this.assets.getSound("explosion")),this.stateMachine.set("menu")})},update:()=>{},render:()=>{this.renderLoading()}},e={name:"menu",enter:()=>{this.hudSystem.setHudVisible(!1),this.hudSystem.setPauseVisible(!1),this.audio.playMusic("doomed",.5),this.menuPulseTime=0},update:a=>{this.menuPulseTime+=a,this.input.wasPressed("Enter")&&(this.audio.resume().then(()=>{this.audio.playMusic("flags",.5)}),this.resetGame(),this.stateMachine.set("playing"))},render:()=>{this.renderTitleScreen()}},s={name:"playing",enter:()=>{this.hudSystem.setHudVisible(!0),this.hudSystem.setPauseVisible(!1),this.audio.playMusic("flags",.5)},update:a=>{if(this.input.wasPressed("p")){this.stateMachine.set("paused");return}this.updatePlaying(a),this.lives===0&&!this.player.alive&&this.stateMachine.set("gameover")},render:()=>{this.renderPlaying()}},i={name:"paused",enter:()=>{this.hudSystem.setHudVisible(!0),this.hudSystem.setPauseVisible(!0)},update:()=>{this.input.wasPressed("p")&&this.stateMachine.set("playing")},render:()=>{this.renderPlaying()},exit:()=>{this.hudSystem.setPauseVisible(!1)}},o={name:"respawn",enter:()=>{this.hudSystem.setHudVisible(!0),this.hudSystem.setPauseVisible(!1)},update:a=>{if(this.updateWorldDuringRespawn(a),this.respawnTimer=Math.max(0,this.respawnTimer-a),this.particles.update(a),this.respawnTimer===0){const h=this.getSafeSpawnPosition();this.player=new R(h,new z(this.input),this.shipSprite),this.playerDeathExploded=!1,this.addEntity(this.player),this.stateMachine.set("playing")}},render:()=>{this.renderPlaying(),this.renderCenterOverlay("Get Ready",`Respawning in ${Math.ceil(this.respawnTimer)}...`)}},n={name:"gameover",enter:()=>{this.hudSystem.setHudVisible(!1),this.hudSystem.setPauseVisible(!1),this.gameOverTime=0},update:a=>{this.gameOverTime+=a,(this.input.wasPressed("Enter")||this.gameOverTime>=3)&&this.stateMachine.set("menu")},render:()=>{this.renderGameOver()}};this.stateMachine.add(t).add(e).add(s).add(i).add(o).add(n)}setupEvents(){this.events.on("asteroid:destroyed",({asteroid:t})=>{this.scoreSystem.onAsteroidDestroyed(t),this.waveSystem.onAsteroidDestroyed()}),this.events.on("enemy:destroyed",()=>{this.scoreSystem.onEnemyDestroyed(),this.waveSystem.onEnemyDestroyed()})}setupSystems(){this.setupUi(),this.waveSystem=new nt({enemySpawnInterval:this.enemySpawnInterval,maxEnemyCap:this.maxEnemyCap,waveTransitionDuration:m.waves.transitionDuration,getEnemyCount:()=>this.enemies.length,getAsteroidCount:()=>this.asteroids.length,spawnEnemy:()=>this.spawnEnemyAtRandom(),spawnAsteroid:t=>this.spawnAsteroidAtRandom(t)}),this.scoreSystem=new at(()=>this.waveSystem.currentWave),this.effectsSystem=new rt(this.audio,this.particles),this.effectsSystem.bind(this.events),this.systems.clear(),this.systems.add(this.waveSystem,10),this.systems.add(this.scoreSystem,20),this.systems.add(this.effectsSystem,30)}updateWorldDuringRespawn(t){super.update(t),this.systems.update(t);const e=[];this.asteroids=this.asteroids.filter(i=>i.alive?!0:(e.push(...i.split()),!1));for(const i of e)this.addAsteroid(i);this.enemies=this.enemies.filter(i=>i.alive),this.resolveEnemyOverlaps();const s=this.player?.position??{x:this.worldSize.x/2,y:this.worldSize.y/2};this.camera.follow(s,this.viewportSize,this.worldSize)}resetGame(){this.lives=3,this.shieldEnergy=1,this.shieldActive=!1,this.shieldRegenCooldown=0,this.respawnTimer=0,this.asteroids=[],this.enemies=[],this.playerDeathExploded=!1,this.entityManager.clear(),this.particles.clear(),this.addEntity(this.particles),this.scoreSystem.reset();const t=this.getSafeSpawnPosition();this.player=new R(t,new z(this.input),this.shipSprite),this.addEntity(this.player),this.waveSystem.reset()}addAsteroid(t){this.waveSystem.registerWaveAsteroid(),this.asteroids.push(t),this.addEntity(t)}addEnemy(t){this.enemies.push(t),this.addEntity(t)}spawnEnemyAtRandom(){let e=0,s=0;for(let i=0;i<10;i++){e=120+Math.random()*(this.worldSize.x-240),s=120+Math.random()*(this.worldSize.y-240);const o=e-this.player.position.x,n=s-this.player.position.y;if(Math.hypot(o,n)>=this.minEnemySpawnDistance)break}this.addEnemy(new E({x:e,y:s},()=>this.player.position,(i,o)=>this.spawnEnemyBullet(i,o),this.enemySprite,i=>this.events.emit("enemy:destroyed",{position:i})))}spawnAsteroidAtRandom(t){let s=0,i=0;for(let o=0;o<10;o++){s=160+Math.random()*(this.worldSize.x-320),i=160+Math.random()*(this.worldSize.y-320);const n=s-this.player.position.x,a=i-this.player.position.y;if(Math.hypot(n,a)>=240)break}this.addAsteroid(new x({x:s,y:i},t,this.onAsteroidDestroyed))}getSafeSpawnPosition(){let e={x:this.worldSize.x/2,y:this.worldSize.y/2};for(let s=0;s<20;s++){const i=200+Math.random()*(this.worldSize.x-400),o=200+Math.random()*(this.worldSize.y-400),n=this.enemies.every(h=>Math.hypot(h.position.x-i,h.position.y-o)>260),a=this.asteroids.every(h=>Math.hypot(h.position.x-i,h.position.y-o)>220);if(n&&a)return{x:i,y:o};e={x:i,y:o}}return e}resolveEnemyOverlaps(){for(let t=0;t<this.enemies.length;t++)for(let e=t+1;e<this.enemies.length;e++){const s=this.enemies[t],i=this.enemies[e],o=i.position.x-s.position.x,n=i.position.y-s.position.y,a=Math.hypot(o,n)||1,h=s.radius+i.radius+4;if(a<h){const l=o/a,c=n/a,d=(h-a)/2;s.position.x-=l*d,s.position.y-=c*d,i.position.x+=l*d,i.position.y+=c*d,s.position.x=Math.max(0,Math.min(s.position.x,this.worldSize.x)),s.position.y=Math.max(0,Math.min(s.position.y,this.worldSize.y)),i.position.x=Math.max(0,Math.min(i.position.x,this.worldSize.x)),i.position.y=Math.max(0,Math.min(i.position.y,this.worldSize.y))}}}spawnEnemyBullet(t,e){this.addEntity(new ot(t,e)),this.events.emit("shot:enemy",{position:t,angle:e})}onAsteroidDestroyed=t=>{this.events.emit("asteroid:destroyed",{asteroid:t})};canTogglePause(){const t=this.stateMachine.currentState?.name;return t==="playing"||t==="paused"}onPause(){this.hudSystem.setPauseVisible(!0)}onResume(){this.hudSystem.setPauseVisible(!1)}renderLoading(){const t=this.ctx.canvas.width,e=this.ctx.canvas.height;this.ctx.clearRect(0,0,t,e),this.ctx.fillStyle="#000000",this.ctx.fillRect(0,0,t,e);const s=300,i=16,o=(t-s)/2,n=e/2-i/2;this.ctx.fillStyle="rgba(255,255,255,0.2)",this.ctx.fillRect(o,n,s,i),this.ctx.fillStyle="rgba(120, 196, 255, 0.9)",this.ctx.fillRect(o,n,s*this.progress,i),this.ctx.fillStyle="#ffffff",this.ctx.font=`18px ${this.fontFamily}`,this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.fillText("Loading assets...",t/2,n-10)}}const L=new ct;L.init({selector:"#app",width:800,height:600,backgroundColor:"#000000"});L.start();
